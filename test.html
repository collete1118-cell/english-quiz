<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>English Mission</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #eef2f5; --card: white; --primary: #3498db; --danger: #e74c3c; --success: #2ecc71; --text: #2c3e50; --btn-shadow: #2980b9; }
    body { font-family: 'Poppins', sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
    .card { background: var(--card); border-radius: 28px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 92%; max-width: 500px; overflow: hidden; margin: 20px 0; display: flex; flex-direction: column; }
    .banner { width: 100%; height: 60px; background: #2c3e50; display: flex; align-items: center; padding: 0 20px; box-sizing: border-box; }
    .banner-text { color: white; margin: 0; font-size: 18px; font-weight: 700; }
    .content { padding: 25px; flex-grow: 1; }
    
    /* Progress Bar */
    .progress-container { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .progress-step { width: 18%; height: 8px; background: #ecf0f1; border-radius: 4px; transition: 0.3s; }
    .progress-step.active { background: var(--primary); }
    
    .scenario-box { background: #fdfdfd; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .instruction-text { font-size: 13.5px; font-weight: 800; color: #2980b9; margin-bottom: 6px; }
    .scenario-text { font-size: 13px; color: var(--text); font-weight: 600; line-height: 1.4; }
    
    /* OPIc Hint & Timer */
    .hint-btn { background: #f39c12; color: white; border: none; padding: 8px 15px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; display: none; margin-bottom: 15px; }
    .hint-text { font-size: 13px; color: #7f8c8d; display: none; margin-bottom: 15px; padding: 10px; background: #fdf2e9; border-radius: 8px; }
    .timer-bar { height: 6px; background: #ecf0f1; border-radius: 3px; overflow: hidden; display: none; margin-bottom: 20px; }
    .timer-fill { height: 100%; background: var(--danger); width: 100%; transition: width 1s linear; }

    .chat-container { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; }
    .chat-row { display: flex; align-items: flex-start; gap: 15px; }
    .chat-row.speaker-b { flex-direction: row-reverse; }
    .chat-avatar-wrapper { display: flex; flex-direction: column; align-items: center; width: 85px; flex-shrink: 0; }
    .chat-avatar-svg { width: 75px; height: 75px; border-radius: 50%; overflow: hidden; background: #ecf0f1; border: 3px solid #bdc3c7; }
    .female-wrapper { border-color: #3498db; background: #e3f2fd; }
    .chat-name { font-size: 12px; font-weight: 800; color: #7f8c8d; margin-top: 6px; text-align: center; }
    .chat-bubble { background: #f1f2f6; padding: 16px; border-radius: 20px; font-size: 15px; line-height: 1.5; color: var(--text); max-width: calc(100% - 100px); }
    .speaker-b .chat-bubble { background: #eef2f7; border: 2px solid var(--primary); font-weight: 600; }
    
    .audio-btn { background: var(--success); color: white; border: none; padding: 14px; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; width: 100%; margin-bottom: 20px; box-shadow: 0 4px #27ae60; transition: 0.1s; }
    .audio-btn:active { top: 4px; box-shadow: 0 0 #27ae60; position: relative; }
    .audio-btn.playing { background: var(--danger); box-shadow: 0 4px #c0392b; }

    .slot-group { display: inline-flex; flex-wrap: wrap; gap: 6px; vertical-align: middle; }
    .slot { padding: 6px 12px; border: 2px dashed #bdc3c7; border-radius: 8px; min-width: 40px; min-height: 24px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--text); cursor: pointer; background: white; font-size: 15px; }
    .slot.filled { border-style: solid; border-color: var(--primary); background: #eef2f7; }
    
    .mcq-btn { width: 100%; text-align: left; padding: 16px; background: white; border: 2px solid #eef2f7; border-radius: 12px; font-size: 15px; font-weight: 600; color: var(--text); margin-bottom: 12px; cursor: pointer; transition: 0.2s; }
    .mcq-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
    
    .word-bank { display: flex; flex-wrap: wrap; gap: 10px; margin: 25px 0 20px; justify-content: center; }
    .word-btn { background: #fff; border: 2px solid var(--primary); color: var(--primary); padding: 10px 18px; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 15px; transition: 0.1s; }
    .word-btn.used { display: none; }
    
    .mic-btn { background: var(--danger); color: white; margin-top: 10px; width: 100%; border-radius: 12px; padding: 16px; font-size: 16px; font-weight: 700; border: none; cursor: pointer; display: none; align-items: center; justify-content: center; box-shadow: 0 4px #c0392b; transition: 0.1s; position: relative; }
    .mic-btn:active { top: 4px; box-shadow: 0 0 #c0392b; }
    .mic-btn.listening { animation: pulse 1.5s infinite; background: #ff6b81; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    
    .button-group { display: flex; gap: 10px; margin-top: 15px; }
    .nav-btn { background: #95a5a6; color: white; border: none; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; flex: 1; box-shadow: 0 4px #7f8c8d; position: relative; }
    .submit-btn { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; flex: 2; box-shadow: 0 4px var(--btn-shadow); position: relative; }
    .nav-btn:active, .submit-btn:active { top: 4px; box-shadow: 0 0 transparent; }

    .feedback { margin-top: 25px; padding: 20px; border-radius: 12px; font-size: 15px; display: none; line-height: 1.6; }
    .correct { background: #e8f8f5; color: #1abc9c; border: 1px solid #1abc9c; }
    .wrong { background: #fdedec; color: var(--danger); border: 1px solid var(--danger); }

    /* ‚òÖ ROBLOX KIDS THEME OVERRIDES ‚òÖ */
    body.roblox-theme { --bg: #2c3e50; --card: #ecf0f1; --primary: #f1c40f; --danger: #e74c3c; --success: #2ecc71; --btn-shadow: #f39c12; font-family: 'Comic Sans MS', 'Poppins', sans-serif; }
    body.roblox-theme .banner { background: #8e44ad; border-bottom: 6px solid #732d91; }
    body.roblox-theme .slot { border: 3px solid #bdc3c7; border-radius: 4px; background: #fff; box-shadow: inset 0 -4px rgba(0,0,0,0.1); font-weight: 900; }
    body.roblox-theme .word-btn { border-radius: 6px; border: 3px solid #f39c12; background: #f1c40f; color: #333; box-shadow: 0 6px #d35400; text-transform: uppercase; }
    body.roblox-theme .word-btn:active { top: 6px; box-shadow: 0 0 #d35400; }
    body.roblox-theme .progress-step { background: #bdc3c7; border: 2px solid #7f8c8d; border-radius: 0; }
    body.roblox-theme .progress-step.active { background: #2ecc71; border-color: #27ae60; }
    
  </style>
</head>
<body>
  <div id="app" class="card">
    <div id="banner" class="banner"><h1 id="title" class="banner-text">Loading...</h1></div>
    <div id="main-content" class="content"><h2 style="text-align:center;">Preparing Mission...üöÄ</h2></div>
  </div>

  <audio id="snd-click" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
  <audio id="snd-oof" src="https://www.myinstants.com/media/sounds/roblox-death-sound_1.mp3"></audio>

<script>
  const params = new URLSearchParams(window.location.search);
  const student = params.get('name') || 'ÏùÄÏòÅ';
  const DEFAULT_API = "https://script.google.com/macros/s/AKfycbxr2-JUh8aQnh7zkygYpZwoquVgwYzoA6CgDxhyrbK8ib0-sh7v_Wk7d2N1VB2mwX2g/exec";
  const API_URL = params.get('api') || DEFAULT_API;

  let questions = [], currentIdx = 0, finalResults = [];
  let userAnswersState = []; 
  let voices = [], isPlayingAudio = false, timerInterval;
  let safeWords = [], mcqSelectedAnswer = "", recognition = null;
  let isKidTheme = false, isOPICMode = false;

  try { const SR = window.SpeechRecognition || window.webkitSpeechRecognition; if(SR) recognition = new SR(); } catch(e){}
  function loadVoices() { voices = window.speechSynthesis.getVoices().filter(v => v.lang.startsWith('en-')); }
  if ('speechSynthesis' in window) { loadVoices(); window.speechSynthesis.onvoiceschanged = loadVoices; }

  fetch(API_URL + "?action=getData&name=" + encodeURIComponent(student))
    .then(r => r.json())
    .then(data => {
      if (data.error) { document.getElementById('main-content').innerHTML = `<h3 style="color:red;text-align:center;">Error: ${data.error}</h3>`; return; }
      questions = data;
      isKidTheme = questions[0].isKid; isOPICMode = questions[0].isOPIc;
      if (isKidTheme) document.body.classList.add('roblox-theme');
      renderCard();
    });

  function playClick() { if(isKidTheme) document.getElementById('snd-click').play().catch(()=>{}); }
  function playOof() { if(isKidTheme) document.getElementById('snd-oof').play().catch(()=>{}); }

  function buildCleanSVG(gender, emotion) {
    const F = gender === 'female'; const skin = F ? '#ffe0bd' : '#f1c27d', hair = '#2c3e50', suit = '#1a252f', shirt = '#ffffff';
    const face = `<rect x="25" y="25" width="50" height="60" rx="25" fill="${skin}"/>`; 
    const hairSVG = F ? `<path d="M 20,80 Q 20,10 50,10 Q 80,10 80,80 Q 85,90 75,90 L 75,50 Q 50,20 25,50 L 25,90 Q 15,90 20,80 Z" fill="${hair}"/>` : `<path d="M 23,50 Q 23,10 50,10 Q 77,10 77,50 Q 77,30 50,25 Q 23,30 23,50 Z" fill="${hair}"/>`;
    const eye = `<ellipse cx="38" cy="50" rx="4" ry="4" fill="#111"/><ellipse cx="62" cy="50" rx="4" ry="4" fill="#111"/>`;
    const mouth = `<path d="M 40,70 Q 50,80 60,70" stroke="#333" stroke-width="3" fill="none"/>`;
    return `<svg viewBox="0 0 100 100" width="100%" height="100%"><path d="M 10,120 Q 50,75 90,120 Z" fill="${suit}"/>${face}${hairSVG}${eye}${mouth}</svg>`;
  }

  function toggleAudio(autoStartTimer) {
    playClick();
    const synth = window.speechSynthesis; const btn = document.getElementById('audio-btn');
    if (isPlayingAudio || synth.speaking) { synth.cancel(); btn.innerHTML = "‚ñ∂Ô∏è Listen"; btn.classList.remove('playing'); isPlayingAudio = false; clearInterval(timerInterval); return; }
    if (!synth || voices.length === 0) return;
    
    btn.innerHTML = "‚èπÔ∏è Stop"; btn.classList.add('playing'); isPlayingAudio = true;
    const voiceA = voices.find(x => x.name.includes('Female')) || voices[0];
    const q = questions[currentIdx];
    const textA = q.speaker_a.replace(/^.*?:/g,'').replace(/[*_~\[\]]/g,'').trim();
    const uA = new SpeechSynthesisUtterance(textA); uA.voice = voiceA; uA.rate = 0.95;
    
    uA.onend = () => { 
      btn.innerHTML = "‚ñ∂Ô∏è Listen"; btn.classList.remove('playing'); isPlayingAudio = false; 
      if(autoStartTimer && isOPICMode && !finalResults[currentIdx]) startOPIcTimer();
    }; 
    synth.speak(uA);
  }

  function startOPIcTimer() {
    const timerBar = document.getElementById('timer-bar');
    const timerFill = document.getElementById('timer-fill');
    const micBtn = document.getElementById('mic-btn');
    timerBar.style.display = 'block'; micBtn.style.display = 'flex';
    let timeLeft = 40; timerFill.style.width = '100%';
    
    timerInterval = setInterval(() => {
      timeLeft--; timerFill.style.width = (timeLeft/40)*100 + '%';
      if(timeLeft <= 0) { clearInterval(timerInterval); checkAnswer(false); }
    }, 1000);
  }

  function showHint() {
    playClick();
    document.getElementById('hint-btn').style.display = 'none';
    document.getElementById('hint-text').style.display = 'block';
  }

  function renderCard() {
    const q = questions[currentIdx];
    document.getElementById('title').innerText = isKidTheme ? `Quest ${currentIdx+1}/5` : `Mission #${currentIdx+1} (Stage ${q.stage})`;
    
    let progressHtml = '<div class="progress-container">' + Array.from({length:5}, (_,i) => `<div class="progress-step ${i<=currentIdx?'active':''}"></div>`).join('') + '</div>';
    
    const svgA = buildCleanSVG(q.coworker_gender, q.emotion_a); const svgB = buildCleanSVG(q.student_gender, q.emotion_b);
    const audioLabel = isOPICMode ? "‚ñ∂Ô∏è Play Ava's Question" : "‚ñ∂Ô∏è Listen Dialogue";
    
    let chatHtml = progressHtml + `<button id="audio-btn" class="audio-btn" onclick="toggleAudio(${isOPICMode})">${audioLabel}</button>`;
    
    if(isOPICMode) {
      chatHtml += `<button id="hint-btn" class="hint-btn" onclick="showHint()">üí° Show Korean Hint</button><div id="hint-text" class="hint-text">${q.korean_hint || ''}</div>`;
      chatHtml += `<div id="timer-bar" class="timer-bar"><div id="timer-fill" class="timer-fill"></div></div>`;
    }

    chatHtml += `<div class="chat-container">
        <div class="chat-row"><div class="chat-avatar-wrapper"><div class="chat-avatar-svg">${svgA}</div><div class="chat-name">${q.coworker_name}</div></div><div class="chat-bubble">${q.speaker_a.replace(/\*\*/g,'')}</div></div>
        <div class="chat-row speaker-b"><div class="chat-avatar-wrapper"><div class="chat-avatar-svg">${svgB}</div><div class="chat-name">${q.student_name}</div></div>`;
    
    let cleanGappedB = q.gapped_b.replace(/\*\*/g,'').replace(/(\[BLANK\]\s*)+/g,'[BLANK]');
    let interactiveArea = "";

    if (q.type === "MCQ") {
      let options = [q.answer, ...q.distractors].filter(Boolean).sort(() => Math.random()-0.5);
      interactiveArea = '<div id="mcq-area">' + options.map(opt => `<button class="mcq-btn ${userAnswersState[currentIdx]===opt?'selected':''}" onclick="selectMCQ(this,'${opt.replace(/'/g,"\\'")}')">${opt}</button>`).join('') + '</div>';
      chatHtml += `<div class="chat-bubble">${cleanGappedB.replace(/\[BLANK\]/g,'_______')}</div></div></div>`;
      mcqSelectedAnswer = userAnswersState[currentIdx] || "";
    } else {
      const chunks = q.chunked_answer || q.answer.split(' ');
      // ‚òÖ Stage 3 Hint Logic: ÎÇ±Îã®Ïñ¥ Ï°∞Î¶Ω Ïãú Ï≤´ Í∏ÄÏûê ÎÖ∏Ï∂ú
      const slotsHtml = '<div class="slot-group">' + Array.from({length:chunks.length},(_,i)=>`<div class="slot" id="slot-${i}" onclick="clearSlot(this)">${q.stage===3 ? chunks[i].charAt(0)+"..." : ""}</div>`).join('') + '</div>';
      chatHtml += `<div class="chat-bubble">${cleanGappedB.replace(/\[BLANK\]/g,slotsHtml)}</div></div></div>`;
      safeWords = [...chunks].sort(()=>Math.random()-0.5);
      interactiveArea = '<div class="word-bank">' + safeWords.map((w,i)=>`<button class="word-btn" id="wb-${i}" onclick="fillSlot(${i},'wb-${i}')">${w}</button>`).join('') + '</div>';
    }

    const prevBtnHtml = currentIdx > 0 ? `<button class="nav-btn" onclick="goPrev()">< Prev</button>` : '';
    document.getElementById('main-content').innerHTML = `<div class="scenario-box"><div class="instruction-text">${q.instruction}</div><div class="scenario-text">${q.scenario}</div></div>` + chatHtml + interactiveArea + `<div id="inline-error" style="color:red;font-weight:bold;display:none;margin-top:10px;"></div><button id="mic-btn" class="mic-btn" onclick="startSpeaking()" style="display:${(q.type!=='MCQ' && !isOPICMode)?'flex':'none'};">üéôÔ∏è Speak Answer</button><div id="feedback" class="feedback"></div><div class="button-group">${prevBtnHtml}<button id="btn" class="submit-btn" onclick="checkAnswer(${q.type === 'MCQ'})">Submit</button></div>`;
    
    // ‚òÖ Ïù¥ÎØ∏ Ìëº Î¨∏Ï†ú ÏÉÅÌÉú Î≥µÏõê (State Retention)
    if (finalResults[currentIdx]) restoreCompletedState();
    else if (q.type !== "MCQ" && userAnswersState[currentIdx]) restoreSlotState();
  }

  function goPrev() { playClick(); if (window.speechSynthesis) window.speechSynthesis.cancel(); clearInterval(timerInterval); if (currentIdx > 0) { currentIdx--; renderCard(); } }

  function restoreSlotState() {
    const saved = userAnswersState[currentIdx], slots = document.querySelectorAll('.slot');
    saved.forEach((w, i) => { if(w && slots[i]) { slots[i].innerText = w; slots[i].classList.add('filled'); const bIdx = safeWords.indexOf(w); if(bIdx>-1) document.getElementById('wb-'+bIdx).classList.add('used'); } });
  }

  function restoreCompletedState() {
    const q = questions[currentIdx], res = finalResults[currentIdx];
    document.getElementById('mic-btn').style.display = 'none';
    if(q.type !== "MCQ") { const slots = document.querySelectorAll('.slot'); q.chunked_answer.forEach((chunk,i)=>{ if(slots[i]){ slots[i].innerText=chunk; slots[i].classList.add('filled'); } }); document.querySelector('.word-bank').style.display = 'none'; }
    const fb = document.getElementById('feedback'); fb.style.display = 'block'; fb.className = res.isCorrect ? "feedback correct" : "feedback wrong";
    fb.innerHTML = res.isCorrect ? `<strong>‚úÖ Perfect!</strong><br><br>B: ${q.full_b}` : `<strong>üí™ Ï†ïÎãµ:</strong> ${q.answer}`;
    document.getElementById('btn').innerText = "Next >"; document.getElementById('btn').onclick = () => { currentIdx++; currentIdx < questions.length ? renderCard() : finish(); };
  }

  function selectMCQ(btn, opt) { playClick(); document.querySelectorAll('.mcq-btn').forEach(b=>b.classList.remove('selected')); btn.classList.add('selected'); mcqSelectedAnswer = opt; userAnswersState[currentIdx] = opt; }

  function fillSlot(wIdx, btnId) { playClick(); const slots = document.querySelectorAll('.slot'); for (let i=0; i<slots.length; i++) { if (!slots[i].classList.contains('filled')) { slots[i].innerText = safeWords[wIdx]; slots[i].dataset.btnId = btnId; slots[i].classList.add('filled'); document.getElementById(btnId).classList.add('used'); userAnswersState[currentIdx] = Array.from(slots).map(s=>s.classList.contains('filled')?s.innerText:""); break; } } }

  function clearSlot(s) { playClick(); if (s.classList.contains('filled')) { if (s.dataset.btnId) document.getElementById(s.dataset.btnId).classList.remove('used'); s.innerText = questions[currentIdx].stage===3 ? questions[currentIdx].chunked_answer[Array.from(document.querySelectorAll('.slot')).indexOf(s)].charAt(0)+"..." : ""; s.classList.remove('filled'); userAnswersState[currentIdx] = Array.from(document.querySelectorAll('.slot')).map(sl=>sl.classList.contains('filled')?sl.innerText:""); } }

  function startSpeaking() {
    playClick(); if (!recognition) return; const micBtn = document.getElementById('mic-btn'); micBtn.classList.add('listening'); micBtn.innerHTML = "üéôÔ∏è Listening...";
    recognition.lang = 'en-US'; try { recognition.start(); } catch(e) {}
    recognition.onresult = function(e) {
      const spoken = e.results[0][0].transcript.toLowerCase().replace(/[.,!?]/g,''); micBtn.classList.remove('listening'); micBtn.innerHTML = "üéôÔ∏è Recognized!";
      const q = questions[currentIdx], targetWords = q.answer.toLowerCase().replace(/[.,!?]/g,'').split(' '), spokenWords = spoken.split(' ');
      let matchCount = 0; targetWords.forEach(w => { if(spokenWords.includes(w)) matchCount++; });
      if ((matchCount/targetWords.length) >= 0.85) { const slots = document.querySelectorAll('.slot'); (q.chunked_answer||q.answer.split(' ')).forEach((c,i) => { if(slots[i]) { slots[i].innerText = c; slots[i].classList.add('filled'); } }); setTimeout(() => checkAnswer(false), 500); } 
      else { playOof(); document.getElementById('inline-error').innerText = "Oof! Recognized: " + spoken; document.getElementById('inline-error').style.display = 'block'; micBtn.innerHTML = "üéôÔ∏è Try Again"; }
    };
    recognition.onerror = function() { micBtn.classList.remove('listening'); micBtn.innerHTML = "üéôÔ∏è Error (Tap again)"; };
    recognition.onend = function() { micBtn.classList.remove('listening'); };
  }

  function checkAnswer(isMCQ) {
    playClick(); clearInterval(timerInterval); const q = questions[currentIdx]; let isWin = false, userAnswer = ""; document.getElementById('inline-error').style.display = 'none';
    if (isMCQ) { userAnswer = mcqSelectedAnswer; isWin = (userAnswer.toLowerCase() === q.answer.toLowerCase()); } 
    else { userAnswer = Array.from(document.querySelectorAll('.slot')).map(s=>s.innerText.trim()).join(' '); isWin = (userAnswer.toLowerCase().replace(/\s+/g,'') === q.answer.toLowerCase().replace(/\s+/g,'')); }
    if (!isWin) playOof();
    finalResults[currentIdx] = { originalIndex: q.originalIndex, question: q.speaker_a, userAnswer, correctAnswer: q.answer, isCorrect: isWin };
    restoreCompletedState();
  }

  function finish() {
    const valid = finalResults.filter(Boolean), correctCnt = valid.filter(r=>r.isCorrect).length;
    document.getElementById('title').innerText = "Mission Clear!";
    document.getElementById('main-content').innerHTML = `<h2 style="text-align:center;">Great job!</h2><h3 style="text-align:center;">Score: ${correctCnt} / 5</h3><button class="submit-btn" onclick="window.close()" style="margin-top:25px;width:100%;">Complete Session</button>`;
    fetch(API_URL + "?action=saveResult&name=" + encodeURIComponent(student), { method: 'POST', body: JSON.stringify(valid) });
  }
</script>
</body>
</html>
