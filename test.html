<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>English Mission</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #eef2f5; --card: white; --primary: #3498db; --danger: #e74c3c;
      --success: #2ecc71; --text: #2c3e50; --btn-shadow: #2980b9;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 20px 0;
    }
    .card {
      background: var(--card);
      border-radius: 28px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      width: 92%;
      max-width: 520px;
      overflow: hidden;
    }
    .banner {
      width: 100%; height: 60px;
      background: #2c3e50;
      display: flex; align-items: center;
      padding: 0 20px;
    }
    .banner-text { color: white; margin: 0; font-size: 18px; font-weight: 700; }
    .content { padding: 20px; }

    /* ‚îÄ‚îÄ Progress ‚îÄ‚îÄ */
    .progress-container { display: flex; justify-content: space-between; margin-bottom: 18px; gap: 6px; }
    .progress-step { flex: 1; height: 8px; background: #ecf0f1; border-radius: 4px; transition: 0.3s; }
    .progress-step.active { background: var(--primary); }

    /* ‚îÄ‚îÄ Scenario ‚îÄ‚îÄ */
    .scenario-box {
      background: #fdfdfd; padding: 14px 16px; border-radius: 12px;
      margin-bottom: 14px; border-left: 4px solid var(--primary);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .instruction-text { font-size: 13.5px; font-weight: 800; color: #2980b9; margin-bottom: 5px; }
    .scenario-text { font-size: 13px; color: var(--text); font-weight: 600; line-height: 1.4; }

    /* ‚îÄ‚îÄ Audio / Hint / Timer ‚îÄ‚îÄ */
    .audio-btn {
      background: var(--success); color: white; border: none;
      padding: 14px; border-radius: 12px; font-size: 15px; font-weight: 700;
      cursor: pointer; width: 100%; margin-bottom: 16px;
      box-shadow: 0 4px #27ae60; transition: 0.1s; position: relative;
    }
    .audio-btn:active { top: 4px; box-shadow: none; }
    .audio-btn.playing { background: var(--danger); box-shadow: 0 4px #c0392b; }

    .hint-btn {
      background: #f39c12; color: white; border: none;
      padding: 8px 15px; border-radius: 8px; font-size: 12px;
      font-weight: bold; cursor: pointer; margin-bottom: 14px; display: none;
    }
    .hint-text {
      font-size: 13px; color: #7f8c8d; display: none;
      margin-bottom: 14px; padding: 10px;
      background: #fdf2e9; border-radius: 8px;
    }
    .timer-bar { height: 6px; background: #ecf0f1; border-radius: 3px; overflow: hidden; display: none; margin-bottom: 18px; }
    .timer-fill { height: 100%; background: var(--danger); width: 100%; transition: width 1s linear; }

    /* ‚îÄ‚îÄ Chat layout ‚îÄ‚îÄ */
    .chat-container { display: flex; flex-direction: column; gap: 18px; margin-bottom: 20px; }

    .chat-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    /* B (student) ‚Üí right-aligned */
    .chat-row.speaker-b {
      flex-direction: row-reverse;
    }

    .chat-avatar-wrapper {
      display: flex; flex-direction: column; align-items: center;
      width: 70px; flex-shrink: 0;
    }
    .chat-avatar-svg {
      width: 64px; height: 64px;
      border-radius: 50%; overflow: hidden;
      background: #ecf0f1;
      border: 3px solid #bdc3c7;
    }
    .female-wrapper { border-color: #3498db !important; background: #e3f2fd !important; }
    .chat-name { font-size: 11px; font-weight: 800; color: #7f8c8d; margin-top: 5px; text-align: center; }

    .chat-bubble {
      background: #f1f2f6; padding: 14px 16px;
      border-radius: 18px; font-size: 14.5px;
      line-height: 1.55; color: var(--text);
      flex: 1; min-width: 0; /* prevents overflow */
    }
    .speaker-b .chat-bubble {
      background: #eef2f7;
      border: 2px solid var(--primary);
      font-weight: 600;
    }

    /* ‚îÄ‚îÄ Slot / Assembly ‚îÄ‚îÄ */
    .slot-group { display: inline-flex; flex-wrap: wrap; gap: 5px; vertical-align: middle; }
    .slot {
      padding: 5px 11px; border: 2px dashed #bdc3c7; border-radius: 8px;
      min-width: 38px; min-height: 34px;
      display: inline-flex; align-items: center; justify-content: center;
      font-weight: 700; color: var(--text); cursor: pointer;
      background: white; font-size: 14px; transition: 0.15s;
    }
    .slot.filled { border-style: solid; border-color: var(--primary); background: #eef2f7; }
    .slot.hint-text-slot { color: #bdc3c7; font-style: italic; font-size: 12px; }

    /* ‚îÄ‚îÄ MCQ ‚îÄ‚îÄ */
    .mcq-area { margin-bottom: 10px; }
    .mcq-btn {
      width: 100%; text-align: left; padding: 14px 16px;
      background: white; border: 2px solid #eef2f7;
      border-radius: 12px; font-size: 14.5px; font-weight: 600;
      color: var(--text); margin-bottom: 10px; cursor: pointer;
      transition: 0.2s;
    }
    .mcq-btn:hover { border-color: var(--primary); background: #f8fbff; }
    .mcq-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }

    /* ‚îÄ‚îÄ Word Bank ‚îÄ‚îÄ */
    .word-bank {
      display: flex; flex-wrap: wrap; gap: 8px;
      margin: 16px 0; justify-content: center;
    }
    .word-btn {
      background: #fff; border: 2px solid var(--primary);
      color: var(--primary); padding: 9px 16px;
      border-radius: 12px; font-weight: 700;
      cursor: pointer; font-size: 14.5px; transition: 0.1s;
    }
    .word-btn:hover { background: var(--primary); color: white; }
    .word-btn.used { visibility: hidden; pointer-events: none; }

    /* ‚îÄ‚îÄ Mic ‚îÄ‚îÄ */
    .mic-btn {
      background: var(--danger); color: white;
      margin-top: 10px; width: 100%;
      border-radius: 12px; padding: 14px;
      font-size: 15px; font-weight: 700;
      border: none; cursor: pointer;
      display: none; align-items: center; justify-content: center;
      box-shadow: 0 4px #c0392b; transition: 0.1s; position: relative;
    }
    .mic-btn:active { top: 4px; box-shadow: none; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
    .mic-btn.listening { animation: pulse 1.5s infinite; background: #ff6b81; }

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .button-group { display: flex; gap: 10px; margin-top: 16px; }
    .nav-btn {
      background: #95a5a6; color: white; border: none;
      padding: 15px; border-radius: 12px; font-size: 15px;
      font-weight: 700; cursor: pointer; flex: 1;
      box-shadow: 0 4px #7f8c8d; position: relative;
    }
    .submit-btn {
      background: var(--primary); color: white; border: none;
      padding: 15px; border-radius: 12px; font-size: 15px;
      font-weight: 700; cursor: pointer; flex: 2;
      box-shadow: 0 4px var(--btn-shadow); position: relative;
    }
    .nav-btn:active, .submit-btn:active { top: 4px; box-shadow: none; }

    /* ‚îÄ‚îÄ Feedback ‚îÄ‚îÄ */
    .feedback {
      margin-top: 20px; padding: 18px; border-radius: 12px;
      font-size: 14.5px; display: none; line-height: 1.6;
    }
    .correct { background: #e8f8f5; color: #1abc9c; border: 1px solid #1abc9c; }
    .wrong   { background: #fdedec; color: var(--danger); border: 1px solid var(--danger); }

    .hint-details {
      margin-top: 10px; background: #fff; border-radius: 8px;
      padding: 12px; border: 1px solid #dcdde1; cursor: pointer;
    }
    .hint-details summary {
      font-size: 13.5px; font-weight: 800; color: #2c3e50;
      outline: none; margin-bottom: 4px;
    }
    .explanation {
      margin-top: 8px; font-size: 13px; color: #34495e;
      font-weight: 500; border-top: 1px solid #eee;
      padding-top: 8px; line-height: 1.5;
    }

    /* ‚îÄ‚îÄ Inline error ‚îÄ‚îÄ */
    #inline-error { color: red; font-weight: bold; display: none; margin-top: 10px; font-size: 13px; }

    /* ‚îÄ‚îÄ Roblox / Kid theme ‚îÄ‚îÄ */
    body.roblox-theme {
      --bg: #2c3e50; --card: #ecf0f1; --primary: #f1c40f;
      --danger: #e74c3c; --success: #2ecc71; --btn-shadow: #f39c12;
      font-family: 'Comic Sans MS', 'Poppins', sans-serif;
    }
    body.roblox-theme .banner { background: #8e44ad; border-bottom: 6px solid #732d91; }
    body.roblox-theme .slot { border: 3px solid #bdc3c7; border-radius: 4px; background: #fff; box-shadow: inset 0 -4px rgba(0,0,0,0.1); font-weight: 900; }
    body.roblox-theme .word-btn { border-radius: 6px; border: 3px solid #f39c12; background: #f1c40f; color: #333; box-shadow: 0 6px #d35400; text-transform: uppercase; }
    body.roblox-theme .word-btn:active { top: 6px; box-shadow: none; }
    body.roblox-theme .progress-step { background: #bdc3c7; border: 2px solid #7f8c8d; border-radius: 0; }
    body.roblox-theme .progress-step.active { background: #2ecc71; border-color: #27ae60; }
  </style>
</head>
<body>
  <div id="app" class="card">
    <div id="banner" class="banner">
      <h1 id="title" class="banner-text">Loading...</h1>
    </div>
    <div id="main-content" class="content">
      <h2 style="text-align:center;">Preparing Mission... üöÄ</h2>
    </div>
  </div>

  <audio id="snd-click" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
  <audio id="snd-oof"   src="https://www.myinstants.com/media/sounds/roblox-death-sound_1.mp3"></audio>

<script>
  /* =========================================================
     CONFIG
  ========================================================= */
  const params = new URLSearchParams(window.location.search);
  const student = params.get('name') || 'ÏùÄÏòÅ';
  const DEFAULT_API = "https://script.google.com/macros/s/AKfycbxr2-JUh8aQnh7zkygYpZwoquVgwYzoA6CgDxhyrbK8ib0-sh7v_Wk7d2N1VB2mwX2g/exec";
  const API_URL = params.get('api') || DEFAULT_API;

  /* =========================================================
     STATE
  ========================================================= */
  let questions = [], currentIdx = 0, finalResults = [];
  let userAnswersState = [];
  let voices = [], isPlayingAudio = false, timerInterval = null;
  let safeWords = [], mcqSelectedAnswer = "", recognition = null;
  let isKidTheme = false, isOPICMode = false;
  let isAnswerSubmitted = false;

  /* =========================================================
     SPEECH
  ========================================================= */
  try {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SR) recognition = new SR();
  } catch(e) {}

  function loadVoices() {
    voices = window.speechSynthesis.getVoices().filter(v => v.lang.startsWith('en-'));
  }
  if ('speechSynthesis' in window) {
    loadVoices();
    window.speechSynthesis.onvoiceschanged = loadVoices;
  }

  /* =========================================================
     FETCH DATA
  ========================================================= */
  fetch(API_URL + "?action=getData&name=" + encodeURIComponent(student))
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        document.getElementById('main-content').innerHTML =
          `<h3 style="color:red;text-align:center;">Error: ${data.error}</h3>`;
        return;
      }
      questions = data;
      isKidTheme  = !!questions[0].isKid;
      isOPICMode  = !!questions[0].isOPIc;
      if (isKidTheme) document.body.classList.add('roblox-theme');
      renderCard();
    })
    .catch(err => {
      document.getElementById('main-content').innerHTML =
        `<h3 style="color:red;text-align:center;">Network error: ${err}</h3>`;
    });

  /* =========================================================
     SOUND HELPERS
  ========================================================= */
  function playClick() { if (isKidTheme) document.getElementById('snd-click').play().catch(() => {}); }
  function playOof()   { if (isKidTheme) document.getElementById('snd-oof').play().catch(() => {}); }

  /* =========================================================
     SVG AVATAR
  ========================================================= */
  function buildCleanSVG(gender, emotion) {
    const F = (gender === 'female');
    const skin = F ? '#ffe0bd' : '#f1c27d', hair = '#2c3e50', suit = '#1a252f';

    const face    = `<rect x="25" y="25" width="50" height="60" rx="25" fill="${skin}"/>`;
    const hairSVG = F
      ? `<path d="M 20,80 Q 20,10 50,10 Q 80,10 80,80 Q 85,90 75,90 L 75,50 Q 50,20 25,50 L 25,90 Q 15,90 20,80 Z" fill="${hair}"/>`
      : `<path d="M 23,50 Q 23,10 50,10 Q 77,10 77,50 Q 77,30 50,25 Q 23,30 23,50 Z" fill="${hair}"/>`;

    const emoMap = {
      urgent:   {bY:2,  bAL:25, bAR:-25, eO:1.2, mT:'wavy',     sweat:true},
      worried:  {bY:1,  bAL:-15,bAR:15,  eO:0.8, mT:'sad'},
      resigned: {bY:-2, bAL:-15,bAR:15,  eO:0.5, mT:'flat',     bags:true},
      happy:    {bY:-2, bAL:-5, bAR:5,   eO:1.0, mT:'bigSmile'},
      understand:{bY:-2,bAL:0,  bAR:0,   eO:1.0, mT:'smile'},
      exhausted:{bY:0,  bAL:0,  bAR:0,   eO:0.3, mT:'flat',     bags:true},
      proud:    {bY:-2, bAL:-5, bAR:5,   eO:1.0, mT:'bigSmile'},
      focused:  {bY:3,  bAL:15, bAR:-15, eO:0.8, mT:'firm'},
      curious:  {bY:-5, bAL:0,  bAR:0,   eO:1.2, mT:'o'},
      serious:  {bY:2,  bAL:5,  bAR:-5,  eO:0.9, mT:'firm'},
      blank:    {bY:0,  bAL:0,  bAR:0,   eO:0.8, mT:'dot'},
    };
    const E = emoMap[emotion] || emoMap.serious;

    const eyeL = `<ellipse cx="38" cy="50" rx="4" ry="${4*E.eO}" fill="#111"/>`;
    const eyeR = `<ellipse cx="62" cy="50" rx="4" ry="${4*E.eO}" fill="#111"/>`;
    const nose  = `<path d="M 50,52 L 50,62 L 53,62" stroke="#d35400" stroke-width="2" fill="none" opacity="0.4" stroke-linecap="round"/>`;
    const browL = `<line x1="30" y1="${42+E.bY}" x2="45" y2="${42+E.bY}" stroke="#333" stroke-width="3.5" stroke-linecap="round" transform="rotate(${E.bAL},37.5,42)"/>`;
    const browR = `<line x1="55" y1="${42+E.bY}" x2="70" y2="${42+E.bY}" stroke="#333" stroke-width="3.5" stroke-linecap="round" transform="rotate(${E.bAR},62.5,42)"/>`;

    let mouth = '';
    if (E.mT==='flat')     mouth=`<line x1="44" y1="70" x2="56" y2="70" stroke="#333" stroke-width="2.5" stroke-linecap="round"/>`;
    if (E.mT==='dot')      mouth=`<line x1="48" y1="70" x2="52" y2="70" stroke="#333" stroke-width="2.5" stroke-linecap="round"/>`;
    if (E.mT==='firm')     mouth=`<line x1="40" y1="70" x2="60" y2="70" stroke="#333" stroke-width="3" stroke-linecap="round"/>`;
    if (E.mT==='sad')      mouth=`<path d="M 45,73 Q 50,65 55,73" stroke="#333" stroke-width="2.5" fill="none" stroke-linecap="round"/>`;
    if (E.mT==='smile')    mouth=`<path d="M 44,68 Q 50,75 56,68" stroke="#333" stroke-width="2.5" fill="none" stroke-linecap="round"/>`;
    if (E.mT==='bigSmile') mouth=`<path d="M 42,68 Q 50,80 58,68 Z" fill="#fff" stroke="#333" stroke-width="2.5"/>`;
    if (E.mT==='o')        mouth=`<circle cx="50" cy="72" r="3.5" fill="#333"/>`;
    if (E.mT==='wavy')     mouth=`<path d="M 42,72 Q 45,68 48,72 Q 52,76 55,72" stroke="#333" stroke-width="2.5" fill="none" stroke-linecap="round"/>`;

    const sweat = E.sweat ? `<g fill="#3498db" opacity="0.8"><ellipse cx="15" cy="40" rx="3" ry="5"/><ellipse cx="10" cy="50" rx="2.5" ry="4"/></g>` : '';
    const bags  = E.bags  ? `<path d="M 32,58 Q 38,62 44,58 M 56,58 Q 62,62 68,58" stroke="#333" stroke-width="1.5" fill="none" opacity="0.4"/>` : '';

    return `<svg viewBox="0 0 100 100" width="100%" height="100%">
      <path d="M 10,120 Q 50,75 90,120 Z" fill="${suit}"/>
      ${face}${hairSVG}${eyeL}${eyeR}${nose}${mouth}${browL}${browR}${sweat}${bags}
    </svg>`;
  }

  /* =========================================================
     AUDIO PLAYBACK
  ========================================================= */
  function toggleAudio(autoStartTimer) {
    playClick();
    const synth = window.speechSynthesis;
    const btn   = document.getElementById('audio-btn');

    if (isPlayingAudio || synth.speaking) {
      synth.cancel();
      btn.innerHTML = isOPICMode ? "‚ñ∂Ô∏è Play Ava's Question" : "‚ñ∂Ô∏è Listen Dialogue";
      btn.classList.remove('playing');
      isPlayingAudio = false;
      clearInterval(timerInterval);
      return;
    }
    if (!synth || voices.length === 0) { alert("ÏùåÏÑ±ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÎàåÎü¨Ï£ºÏÑ∏Ïöî."); return; }

    btn.innerHTML = "‚èπÔ∏è Stop"; btn.classList.add('playing'); isPlayingAudio = true;

    const q = questions[currentIdx];
    const pickVoice = (g) => voices.find(v => v.name.toLowerCase().includes(g)) || voices[0];
    const voiceA = pickVoice(q.coworker_gender === 'female' ? 'female' : 'male');
    const voiceB = pickVoice(q.student_gender  === 'female' ? 'female' : 'male');

    const clean = s => s.replace(/^[^:]+:\s*/,'').replace(/[*_~\[\]]/g,'').replace(/\[BLANK\]/gi,'blank').trim();
    const textA = clean(q.speaker_a);
    const textB = clean(finalResults[currentIdx] ? q.answer : q.gapped_b);

    const uA = new SpeechSynthesisUtterance(textA); uA.voice = voiceA; uA.rate = 0.95;
    const uB = new SpeechSynthesisUtterance(textB); uB.voice = voiceB; uB.rate = 0.95;

    const resetBtn = () => {
      btn.innerHTML = isOPICMode ? "‚ñ∂Ô∏è Play Ava's Question" : "‚ñ∂Ô∏è Listen Dialogue";
      btn.classList.remove('playing');
      isPlayingAudio = false;
    };
    uB.onend = () => { resetBtn(); if (autoStartTimer && isOPICMode && !finalResults[currentIdx]) startOPIcTimer(); };
    uB.onerror = resetBtn;
    uA.onend   = () => { if (isPlayingAudio) setTimeout(() => synth.speak(uB), 400); };
    uA.onerror = resetBtn;

    synth.speak(uA);
  }

  /* =========================================================
     OPIc TIMER
  ========================================================= */
  function startOPIcTimer() {
    const timerBar  = document.getElementById('timer-bar');
    const timerFill = document.getElementById('timer-fill');
    const micBtn    = document.getElementById('mic-btn');
    if (!timerBar) return;
    timerBar.style.display = 'block';
    if (micBtn) micBtn.style.display = 'flex';
    let timeLeft = 40; timerFill.style.width = '100%';
    timerInterval = setInterval(() => {
      timeLeft--;
      timerFill.style.width = (timeLeft / 40 * 100) + '%';
      if (timeLeft <= 0) { clearInterval(timerInterval); submitAnswer(); }
    }, 1000);
  }

  /* =========================================================
     HINT
  ========================================================= */
  function showHint() {
    playClick();
    document.getElementById('hint-btn').style.display = 'none';
    document.getElementById('hint-text').style.display = 'block';
  }

  /* =========================================================
     STAGE-3 SLOT HINT (first letter only for first chunk /
     after comma / after conjunction)
  ========================================================= */
  function getStage3Hint(chunk, index, allChunks) {
    if (!chunk || questions[currentIdx].stage !== 3) return '';
    if (index === 0) return chunk.charAt(0) + '‚Ä¶';
    const prev = (allChunks[index - 1] || '').trim().toLowerCase();
    if (prev.endsWith(',')) return chunk.charAt(0) + '‚Ä¶';
    const conjunctions = ['and','but','because','so','or','if','although','though'];
    const lastWord = prev.replace(/[^a-z0-9\s]/g,'').split(/\s+/).pop();
    if (conjunctions.includes(lastWord)) return chunk.charAt(0) + '‚Ä¶';
    return '';
  }

  /* =========================================================
     NORMALIZE (shared helper, defined at top level)
  ========================================================= */
  function normalizeText(text) {
    return (text || '').toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g,' ').trim();
  }

  /* =========================================================
     RENDER CARD  ‚Üê main fix is here
  ========================================================= */
  function renderCard() {
    const q = questions[currentIdx];
    isAnswerSubmitted = false;
    mcqSelectedAnswer = userAnswersState[currentIdx] || '';

    /* ‚îÄ‚îÄ title ‚îÄ‚îÄ */
    document.getElementById('title').innerText =
      isKidTheme ? `Quest ${currentIdx+1}/${questions.length}` : `Mission #${currentIdx+1} (Stage ${q.stage})`;

    /* ‚îÄ‚îÄ progress bar ‚îÄ‚îÄ */
    const progressHtml = '<div class="progress-container">' +
      Array.from({length: questions.length}, (_, i) =>
        `<div class="progress-step ${i <= currentIdx ? 'active' : ''}"></div>`
      ).join('') + '</div>';

    /* ‚îÄ‚îÄ avatars ‚îÄ‚îÄ */
    const svgA = buildCleanSVG(q.coworker_gender, q.emotion_a || 'serious');
    const svgB = buildCleanSVG(q.student_gender,  q.emotion_b || 'focused');
    const wrapClassA = q.coworker_gender === 'female' ? 'female-wrapper' : '';
    const wrapClassB = q.student_gender  === 'female' ? 'female-wrapper' : '';

    /* ‚îÄ‚îÄ clean speaker text ‚îÄ‚îÄ */
    const cleanSpeakerA = (q.speaker_a || '').replace(/\*\*/g, '');

    /* ‚îÄ‚îÄ ASSEMBLY: build bubble with inline slots ‚îÄ‚îÄ */
    let bubbleB_html = '';
    let wordBankHtml  = '';
    let mcqAreaHtml   = '';
    let micDisplay    = 'none';

    if (q.type === 'MCQ') {
      /* MCQ: blank shown as underline, choices below */
      const cleanGapped = (q.gapped_b || '').replace(/\*\*/g,'').replace(/(\[BLANK\]\s*)+/g, '_______');
      bubbleB_html = cleanGapped;

      const options = [q.answer, ...(q.distractors || [])].filter(Boolean).sort(() => Math.random() - 0.5);
      mcqAreaHtml = '<div class="mcq-area">' +
        options.map(opt =>
          `<button class="mcq-btn ${mcqSelectedAnswer === opt ? 'selected' : ''}"
            onclick="selectMCQ(this,'${opt.replace(/\\/g,'\\\\').replace(/'/g,"\\'")}')">
            ${opt}
          </button>`
        ).join('') + '</div>';

    } else {
      /* ASSEMBLY: inject slot-group INLINE into gapped_b */
      const chunks   = q.chunked_answer || q.answer.split(' ');
      safeWords      = [...chunks].sort(() => Math.random() - 0.5);

      /* Build the slot-group HTML */
      const slotsHtml = '<span class="slot-group">' +
        Array.from({length: chunks.length}, (_, i) => {
          const hintText = getStage3Hint(chunks[i], i, chunks);
          return `<span class="slot${hintText ? ' hint-text-slot' : ''}" id="slot-${i}"
                    data-btn-id="" onclick="clearSlot(this,${i})">${hintText || ''}</span>`;
        }).join('') + '</span>';

      /* Replace [BLANK] in gapped_b with the slot group */
      const cleanGapped = (q.gapped_b || '').replace(/\*\*/g,'').replace(/(\[BLANK\]\s*)+/g, '[BLANK]');
      bubbleB_html = cleanGapped.replace('[BLANK]', slotsHtml);

      /* Word bank */
      wordBankHtml = '<div class="word-bank" id="word-bank">' +
        safeWords.map((w, i) =>
          `<button class="word-btn" id="wb-${i}" onclick="fillSlot(${i},'wb-${i}')">${w}</button>`
        ).join('') + '</div>';

      /* Show mic for ASSEMBLY non-OPIc only */
      if (!isOPICMode) micDisplay = 'flex';
    }

    /* ‚îÄ‚îÄ OPIc extras ‚îÄ‚îÄ */
    let opicExtras = '';
    if (isOPICMode) {
      opicExtras = `
        <button id="hint-btn" class="hint-btn" onclick="showHint()" style="display:block;">üí° Show Korean Hint</button>
        <div id="hint-text" class="hint-text">${q.korean_hint || ''}</div>
        <div id="timer-bar" class="timer-bar"><div id="timer-fill" class="timer-fill"></div></div>`;
    }

    /* ‚îÄ‚îÄ prev button ‚îÄ‚îÄ */
    const prevBtnHtml = currentIdx > 0
      ? `<button class="nav-btn" onclick="goPrev()">‚Üê Prev</button>` : '';

    /* ‚îÄ‚îÄ assemble full HTML ‚îÄ‚îÄ */
    document.getElementById('main-content').innerHTML = `
      <div class="scenario-box">
        <div class="instruction-text">${q.instruction || ''}</div>
        <div class="scenario-text">${q.scenario || ''}</div>
      </div>
      ${progressHtml}
      <button id="audio-btn" class="audio-btn" onclick="toggleAudio(${isOPICMode})">
        ${isOPICMode ? "‚ñ∂Ô∏è Play Ava's Question" : "‚ñ∂Ô∏è Listen Dialogue"}
      </button>
      ${opicExtras}

      <div class="chat-container">
        <!-- Speaker A (coworker) ‚Äî LEFT -->
        <div class="chat-row">
          <div class="chat-avatar-wrapper">
            <div class="chat-avatar-svg ${wrapClassA}">${svgA}</div>
            <div class="chat-name">${q.coworker_name || ''}</div>
          </div>
          <div class="chat-bubble">${cleanSpeakerA}</div>
        </div>

        <!-- Speaker B (student) ‚Äî RIGHT -->
        <div class="chat-row speaker-b">
          <div class="chat-avatar-wrapper">
            <div class="chat-avatar-svg ${wrapClassB}">${svgB}</div>
            <div class="chat-name">${q.student_name || student}</div>
          </div>
          <div class="chat-bubble">${bubbleB_html}</div>
        </div>
      </div>

      ${mcqAreaHtml}
      ${wordBankHtml}

      <div id="inline-error"></div>
      <button id="mic-btn" class="mic-btn" onclick="startSpeaking()"
        style="display:${micDisplay};">üéôÔ∏è Speak Answer</button>
      <div id="feedback" class="feedback"></div>
      <div class="button-group">
        ${prevBtnHtml}
        <button id="btn" class="submit-btn" onclick="submitAnswer()">Submit ‚úì</button>
      </div>
    `;

    /* restore state if already answered */
    if (finalResults[currentIdx]) {
      restoreCompletedState();
    } else if (q.type !== 'MCQ' && Array.isArray(userAnswersState[currentIdx])) {
      restoreSlotState();
    }
  }

  /* =========================================================
     NAVIGATION
  ========================================================= */
  function goPrev() {
    playClick();
    if (window.speechSynthesis) window.speechSynthesis.cancel();
    clearInterval(timerInterval);
    if (currentIdx > 0) { currentIdx--; renderCard(); }
  }

  /* =========================================================
     RESTORE SLOT STATE
  ========================================================= */
  function restoreSlotState() {
    const saved = userAnswersState[currentIdx];
    if (!Array.isArray(saved)) return;
    saved.forEach((word, i) => {
      const slot = document.getElementById('slot-' + i);
      if (!slot || !word) return;
      /* find matching word bank button */
      const wbIdx = safeWords.indexOf(word);
      if (wbIdx > -1) {
        const wb = document.getElementById('wb-' + wbIdx);
        if (wb) { wb.classList.add('used'); slot.dataset.btnId = 'wb-' + wbIdx; }
      }
      slot.innerText = word;
      slot.classList.add('filled');
      slot.classList.remove('hint-text-slot');
    });
  }

  /* =========================================================
     MCQ SELECT
  ========================================================= */
  function selectMCQ(btn, opt) {
    playClick();
    document.querySelectorAll('.mcq-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    mcqSelectedAnswer = opt;
    userAnswersState[currentIdx] = opt;
  }

  /* =========================================================
     FILL / CLEAR SLOT
  ========================================================= */
  function fillSlot(wIdx, btnId) {
    playClick();
    const slots = document.querySelectorAll('.slot');
    for (let i = 0; i < slots.length; i++) {
      if (!slots[i].classList.contains('filled')) {
        slots[i].innerText    = safeWords[wIdx];
        slots[i].dataset.btnId = btnId;
        slots[i].classList.add('filled');
        slots[i].classList.remove('hint-text-slot');
        const wb = document.getElementById(btnId);
        if (wb) wb.classList.add('used');
        /* save state */
        userAnswersState[currentIdx] = Array.from(document.querySelectorAll('.slot'))
          .map(s => s.classList.contains('filled') ? s.innerText : '');
        break;
      }
    }
  }

  function clearSlot(slotEl, idx) {
    playClick();
    if (!slotEl.classList.contains('filled')) return;
    /* restore word bank button */
    if (slotEl.dataset.btnId) {
      const wb = document.getElementById(slotEl.dataset.btnId);
      if (wb) wb.classList.remove('used');
    }
    /* restore hint if stage 3 */
    const q = questions[currentIdx];
    const chunks = q.chunked_answer || q.answer.split(' ');
    const hintText = getStage3Hint(chunks[idx], idx, chunks);
    slotEl.innerText    = hintText || '';
    slotEl.dataset.btnId = '';
    slotEl.classList.remove('filled');
    if (hintText) slotEl.classList.add('hint-text-slot');
    /* save state */
    userAnswersState[currentIdx] = Array.from(document.querySelectorAll('.slot'))
      .map(s => s.classList.contains('filled') ? s.innerText : '');
  }

  /* =========================================================
     SUBMIT
  ========================================================= */
  function submitAnswer() {
    if (isAnswerSubmitted) return;
    playClick();
    clearInterval(timerInterval);
    if (recognition) { try { recognition.abort(); } catch(e) {} }

    const q = questions[currentIdx];
    let isWin = false, userAnswer = '';

    if (q.type === 'MCQ') {
      userAnswer = mcqSelectedAnswer;
      if (!userAnswer) {
        showInlineError('Please select an answer first!');
        return;
      }
      isWin = normalizeText(userAnswer) === normalizeText(q.answer);
    } else {
      const slots = Array.from(document.querySelectorAll('.slot'));
      /* check all slots are filled */
      const allFilled = slots.every(s => s.classList.contains('filled'));
      if (!allFilled) {
        showInlineError('Please fill in all the blanks!');
        return;
      }
      userAnswer = slots.map(s => s.innerText.trim()).join(' ');
      isWin = normalizeText(userAnswer) === normalizeText(q.answer);
    }

    if (!isWin) playOof();

    finalResults[currentIdx] = {
      originalIndex: q.originalIndex,
      question:      q.speaker_a,
      userAnswer:    userAnswer,
      correctAnswer: q.answer,
      isCorrect:     isWin,
    };
    restoreCompletedState();
  }

  function showInlineError(msg) {
    const el = document.getElementById('inline-error');
    if (!el) return;
    el.innerText = msg;
    el.style.display = 'block';
    el.style.color   = 'red';
    el.style.fontWeight = 'bold';
    el.style.marginTop  = '8px';
    setTimeout(() => { el.style.display = 'none'; }, 2500);
  }

  /* =========================================================
     RESTORE COMPLETED STATE (after correct/wrong)
  ========================================================= */
  function restoreCompletedState() {
    isAnswerSubmitted = true;
    const q   = questions[currentIdx];
    const res = finalResults[currentIdx];

    /* confetti */
    if (res.isCorrect) {
      try { confetti({ particleCount: 150, spread: 80, origin: { y: 0.1 } }); } catch(e) {}
    }

    /* hide mic */
    const mic = document.getElementById('mic-btn');
    if (mic) mic.style.display = 'none';

    /* fill all slots with correct answer */
    if (q.type !== 'MCQ') {
      const chunks = q.chunked_answer || q.answer.split(' ');
      chunks.forEach((chunk, i) => {
        const slot = document.getElementById('slot-' + i);
        if (slot) { slot.innerText = chunk; slot.classList.add('filled'); slot.classList.remove('hint-text-slot'); }
      });
      const wb = document.getElementById('word-bank');
      if (wb) wb.style.display = 'none';
    }

    /* feedback */
    const fb = document.getElementById('feedback');
    fb.style.display = 'block';
    fb.className = res.isCorrect ? 'feedback correct' : 'feedback wrong';

    let expHtml = `<span style="color:#7f8c8d;font-weight:600;">üìù Original:</span> ${q.original_expr || 'N/A'}<br>`;
    expHtml    += `<span style="color:#2980b9;font-weight:700;">‚ú® Polished:</span> ${q.answer}<br>`;
    expHtml    += `<span style="color:#e74c3c;display:block;margin-top:6px;">üí° Why: ${q.why_explanation || ''}</span>`;

    fb.innerHTML = (res.isCorrect ? '<strong>‚úÖ Perfect!</strong>' : `<strong>üí™ Ï†ïÎãµ:</strong> ${q.answer}`) +
      `<details class="hint-details" open>
        <summary>üí° Review Note (Click to toggle)</summary>
        <div class="explanation">${expHtml}</div>
      </details>`;

    /* next button */
    const btn = document.getElementById('btn');
    btn.innerText = currentIdx < questions.length - 1 ? 'Next ‚Üí' : 'Finish üéâ';
    btn.onclick = () => {
      playClick();
      currentIdx++;
      if (currentIdx < questions.length) renderCard();
      else finish();
    };
  }

  /* =========================================================
     MIC / SPEECH RECOGNITION
  ========================================================= */
  function startSpeaking() {
    playClick();
    if (!recognition || isAnswerSubmitted) return;
    const micBtn = document.getElementById('mic-btn');
    micBtn.classList.add('listening');
    micBtn.innerHTML = 'üéôÔ∏è Listening...';
    recognition.lang = 'en-US';
    try { recognition.start(); } catch(e) { micBtn.classList.remove('listening'); micBtn.innerHTML = 'üéôÔ∏è Error ‚Äì tap again'; return; }

    recognition.onresult = (e) => {
      const spoken = e.results[0][0].transcript;
      micBtn.classList.remove('listening');
      micBtn.innerHTML = 'üéôÔ∏è Speak Answer';

      const q = questions[currentIdx];
      const spokenWords = normalizeText(spoken).split(' ');
      const targetWords = normalizeText(q.answer).split(' ');
      const matchCount  = targetWords.filter(w => spokenWords.includes(w)).length;

      if (matchCount / targetWords.length >= 0.65) {
        /* fill slots with correct answer and submit */
        const chunks = q.chunked_answer || q.answer.split(' ');
        chunks.forEach((c, i) => {
          const slot = document.getElementById('slot-' + i);
          if (slot) { slot.innerText = c; slot.classList.add('filled'); slot.classList.remove('hint-text-slot'); }
        });
        submitAnswer();
      } else {
        playOof();
        showInlineError('Oof! I heard: "' + spoken + '"');
        setTimeout(() => { if (!isAnswerSubmitted) submitAnswer(); }, 1800);
      }
    };
    recognition.onerror = () => {
      micBtn.classList.remove('listening');
      micBtn.innerHTML = 'üéôÔ∏è Error ‚Äì tap again';
    };
    recognition.onend = () => {
      if (!isAnswerSubmitted) { micBtn.classList.remove('listening'); micBtn.innerHTML = 'üéôÔ∏è Speak Answer'; }
    };
  }

  /* =========================================================
     FINISH
  ========================================================= */
  function finish() {
    const valid      = finalResults.filter(Boolean);
    const correctCnt = valid.filter(r => r.isCorrect).length;

    document.getElementById('title').innerText = 'üéâ Mission Clear!';
    document.getElementById('main-content').innerHTML = `
      <h2 style="text-align:center;">Great job, ${student}! üéä</h2>
      <h3 style="text-align:center;">Score: ${correctCnt} / ${questions.length}</h3>
      <p style="text-align:center;color:#7f8c8d;font-size:13px;">Saving results & analyzing weaknesses... ‚è≥</p>
      <button id="complete-btn" class="submit-btn" style="margin-top:25px;width:100%;opacity:0.5;" disabled>Please wait...</button>
    `;

    fetch(API_URL + "?action=saveResult&name=" + encodeURIComponent(student), {
      method: 'POST',
      body: JSON.stringify(valid),
    })
    .then(() => {
      const btn = document.getElementById('complete-btn');
      btn.innerText  = '‚úÖ Complete Session';
      btn.style.opacity = '1';
      btn.disabled   = false;
      btn.onclick    = () => window.close();
    })
    .catch(() => {
      const btn = document.getElementById('complete-btn');
      btn.innerText  = '‚ö†Ô∏è Save failed ‚Äì Close anyway';
      btn.style.opacity = '1';
      btn.disabled   = false;
      btn.onclick    = () => window.close();
    });
  }
</script>
</body>
</html>
