<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>English Mission</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#eef2f5; --card:white; --primary:#3498db; --danger:#e74c3c; --success:#2ecc71; --text:#2c3e50; --btn-shadow:#2980b9; }
    * { box-sizing:border-box; }
    body { font-family:'Poppins',sans-serif; background:var(--bg); display:flex; justify-content:center; align-items:flex-start; min-height:100vh; margin:0; padding:20px 0; }
    .card { background:var(--card); border-radius:28px; box-shadow:0 15px 35px rgba(0,0,0,0.1); width:92%; max-width:540px; overflow:hidden; }
    .banner { width:100%; height:60px; background:#2c3e50; display:flex; align-items:center; padding:0 20px; }
    .banner-text { color:white; margin:0; font-size:18px; font-weight:700; }
    .content { padding:20px; }

    .progress-container { display:flex; justify-content:space-between; margin-bottom:18px; gap:6px; }
    .progress-step { flex:1; height:8px; background:#ecf0f1; border-radius:4px; transition:0.3s; }
    .progress-step.active { background:var(--primary); }

    .scenario-box { background:#fdfdfd; padding:14px 16px; border-radius:12px; margin-bottom:14px; border-left:4px solid var(--primary); box-shadow:0 2px 8px rgba(0,0,0,0.04); }
    .instruction-text { font-size:13.5px; font-weight:800; color:#2980b9; margin-bottom:5px; }
    .scenario-text { font-size:13px; color:var(--text); font-weight:600; line-height:1.4; }

    .audio-btn { background:var(--success); color:white; border:none; padding:14px; border-radius:12px; font-size:15px; font-weight:700; cursor:pointer; width:100%; margin-bottom:16px; box-shadow:0 4px #27ae60; transition:0.1s; position:relative; }
    .audio-btn:active { top:4px; box-shadow:none; }
    .audio-btn.playing { background:var(--danger); box-shadow:0 4px #c0392b; }

    .hint-btn { background:#f39c12; color:white; border:none; padding:8px 15px; border-radius:8px; font-size:12px; font-weight:bold; cursor:pointer; margin-bottom:14px; display:none; }
    .hint-text-opic { font-size:13px; color:#7f8c8d; display:none; margin-bottom:14px; padding:10px; background:#fdf2e9; border-radius:8px; }
    .timer-bar { height:6px; background:#ecf0f1; border-radius:3px; overflow:hidden; display:none; margin-bottom:18px; }
    .timer-fill { height:100%; background:var(--danger); width:100%; transition:width 1s linear; }

    .chat-container { display:flex; flex-direction:column; gap:18px; margin-bottom:20px; }
    .chat-row { display:flex; align-items:flex-start; gap:12px; }
    .chat-row.speaker-b { flex-direction:row-reverse; }
    .chat-avatar-wrapper { display:flex; flex-direction:column; align-items:center; width:92px; flex-shrink:0; }
    .chat-avatar-svg { width:86px; height:86px; border-radius:50%; overflow:hidden; background:#ecf0f1; border:3px solid #bdc3c7; }
    .female-wrapper { border-color:#3498db !important; background:#e3f2fd !important; }
    .chat-name { font-size:12px; font-weight:800; color:#7f8c8d; margin-top:5px; text-align:center; }
    .chat-bubble { background:#f1f2f6; padding:14px 16px; border-radius:18px; font-size:14.5px; line-height:1.6; color:var(--text); flex:1; min-width:0; }
    .speaker-b .chat-bubble { background:#eef2f7; border:2px solid var(--primary); font-weight:600; }

    .slot-group { display:inline-flex; flex-wrap:wrap; gap:5px; vertical-align:middle; margin:2px 0; }
    .slot { padding:6px 14px; border:2px dashed #bdc3c7; border-radius:10px; min-width:44px; min-height:36px; display:inline-flex; align-items:center; justify-content:center; font-weight:700; color:var(--text); cursor:pointer; background:white; font-size:14px; transition:0.15s; white-space:nowrap; }
    .slot.filled { border-style:solid; border-color:var(--primary); background:#eef2f7; }
    .slot.hint-slot { color:#aab0ba; font-style:italic; font-size:12px; }

    .mcq-area { margin-bottom:10px; }
    .mcq-btn { width:100%; text-align:left; padding:14px 16px; background:white; border:2px solid #eef2f7; border-radius:12px; font-size:14.5px; font-weight:600; color:var(--text); margin-bottom:10px; cursor:pointer; transition:0.2s; }
    .mcq-btn:hover { border-color:var(--primary); background:#f8fbff; }
    .mcq-btn.selected { background:var(--primary); color:white; border-color:var(--primary); }

    .word-bank { display:flex; flex-wrap:wrap; gap:8px; margin:16px 0; justify-content:center; }
    .word-btn { background:#fff; border:2px solid var(--primary); color:var(--primary); padding:9px 16px; border-radius:12px; font-weight:700; cursor:pointer; font-size:14.5px; transition:0.1s; white-space:nowrap; }
    .word-btn:hover { background:var(--primary); color:white; }
    .word-btn.used { visibility:hidden; pointer-events:none; }

    .mic-btn { background:var(--danger); color:white; margin-top:10px; width:100%; border-radius:12px; padding:14px; font-size:15px; font-weight:700; border:none; cursor:pointer; display:none; align-items:center; justify-content:center; gap:8px; box-shadow:0 4px #c0392b; transition:background 0.2s; position:relative; }
    .mic-btn:active { top:4px; box-shadow:none; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
    .mic-btn.listening { animation:pulse 1.2s infinite; background:#e84393; box-shadow:0 4px #b5006e; }

    .transcript-box { display:none; margin-top:10px; padding:10px 14px; border-radius:10px; background:#fdf2e9; border:1px solid #f39c12; font-size:13.5px; color:#7f6000; font-style:italic; min-height:38px; line-height:1.5; }
    .transcript-box.show { display:block; }

    .button-group { display:flex; gap:10px; margin-top:16px; }
    .nav-btn { background:#95a5a6; color:white; border:none; padding:15px; border-radius:12px; font-size:15px; font-weight:700; cursor:pointer; flex:1; box-shadow:0 4px #7f8c8d; position:relative; }
    .submit-btn { background:var(--primary); color:white; border:none; padding:15px; border-radius:12px; font-size:15px; font-weight:700; cursor:pointer; flex:2; box-shadow:0 4px var(--btn-shadow); position:relative; }
    .nav-btn:active, .submit-btn:active { top:4px; box-shadow:none; }

    .feedback { margin-top:20px; padding:18px; border-radius:12px; font-size:14.5px; display:none; line-height:1.6; }
    .correct { background:#e8f8f5; color:#1abc9c; border:1px solid #1abc9c; }
    .wrong   { background:#fdedec; color:var(--danger); border:1px solid var(--danger); }
    .hint-details { margin-top:10px; background:#fff; border-radius:8px; padding:12px; border:1px solid #dcdde1; }
    .hint-details summary { font-size:13.5px; font-weight:800; color:#2c3e50; outline:none; margin-bottom:4px; cursor:pointer; }
    .explanation { margin-top:8px; font-size:13px; color:#34495e; font-weight:500; border-top:1px solid #eee; padding-top:8px; line-height:1.6; }
    .why-block { display:block; margin-top:8px; padding:8px 12px; background:#fff8e1; border-left:3px solid #f39c12; border-radius:6px; color:#7f6000; font-weight:600; }

    #inline-error { display:none; margin-top:8px; padding:8px 12px; background:#fdedec; border-radius:8px; color:var(--danger); font-weight:700; font-size:13px; }

    body.roblox-theme { --bg:#2c3e50; --card:#ecf0f1; --primary:#f1c40f; --danger:#e74c3c; --success:#2ecc71; --btn-shadow:#f39c12; font-family:'Comic Sans MS','Poppins',sans-serif; }
    body.roblox-theme .banner { background:#8e44ad; border-bottom:6px solid #732d91; }
    body.roblox-theme .slot { border:3px solid #bdc3c7; border-radius:4px; background:#fff; font-weight:900; }
    body.roblox-theme .word-btn { border-radius:6px; border:3px solid #f39c12; background:#f1c40f; color:#333; box-shadow:0 6px #d35400; text-transform:uppercase; }
    body.roblox-theme .progress-step { background:#bdc3c7; border:2px solid #7f8c8d; border-radius:0; }
    body.roblox-theme .progress-step.active { background:#2ecc71; border-color:#27ae60; }
  </style>
</head>
<body>
  <div id="app" class="card">
    <div id="banner" class="banner"><h1 id="title" class="banner-text">Loading...</h1></div>
    <div id="main-content" class="content"><h2 style="text-align:center;">Preparing Mission... üöÄ</h2></div>
  </div>
  <audio id="snd-click" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
  <audio id="snd-oof"   src="https://www.myinstants.com/media/sounds/roblox-death-sound_1.mp3"></audio>

<script>
  /* ‚îÄ‚îÄ Config ‚îÄ‚îÄ */
  const params  = new URLSearchParams(window.location.search);
  const student = params.get('name') || 'ÏùÄÏòÅ';
  const DEFAULT_API = "https://script.google.com/macros/s/AKfycbxr2-JUh8aQnh7zkygYpZwoquVgwYzoA6CgDxhyrbK8ib0-sh7v_Wk7d2N1VB2mwX2g/exec";
  const API_URL = params.get('api') || DEFAULT_API;

  /* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
  let questions=[], currentIdx=0, finalResults=[], userAnswersState=[];
  let voices=[], isPlayingAudio=false, timerInterval=null;
  let safeWords=[], mcqSelectedAnswer='';
  let isKidTheme=false, isOPICMode=false, isAnswerSubmitted=false;
  let recog=null;

  /* ‚îÄ‚îÄ TTS voices ‚îÄ‚îÄ */
  function loadVoicesOnce() {
    const all = window.speechSynthesis.getVoices();
    if (!all || all.length === 0) return;
    voices = all.filter(v => v.lang && v.lang.startsWith('en-'));
  }
  function loadVoices() {
    loadVoicesOnce();
    window.speechSynthesis.onvoiceschanged = () => {
      loadVoicesOnce();
    };
  }
  if ('speechSynthesis' in window) {
    loadVoices();
  }

  function pickVoice(wantFemale){
    if (!voices || voices.length === 0) return null;
    const femaleNames=['Samantha','Karen','Moira','Fiona','Tessa','Victoria','Allison','Ava','Susan','Kathy','Vicki','Zira','Hazel','Linda','Microsoft Zira'];
    const maleNames  =['Daniel','Alex','Tom','Fred','Junior','Reed','Lee','Rishi','Oliver','David','Mark','Microsoft David','Microsoft Mark'];
    if (wantFemale){
      return voices.find(v=>femaleNames.some(n=>v.name.includes(n)))
          || voices.find(v=>v.name.toLowerCase().includes('female'))
          || voices.find(v=>!maleNames.some(n=>v.name.includes(n)))
          || voices[0];
    } else {
      return voices.find(v=>maleNames.some(n=>v.name.includes(n)))
          || voices.find(v=>v.name.toLowerCase().includes('male'))
          || voices.find(v=>!femaleNames.some(n=>v.name.includes(n)))
          || (voices.length>1?voices[1]:voices[0]);
    }
  }

  /* ‚îÄ‚îÄ Fetch questions ‚îÄ‚îÄ */
  fetch(API_URL+'?action=getData&name='+encodeURIComponent(student))
    .then(r=>r.json())
    .then(data=>{
      if(data.error){
        document.getElementById('main-content').innerHTML=
          `<h3 style="color:red;text-align:center;">Error: ${data.error}</h3>`;
        return;
      }
      questions=data;
      isKidTheme=!!questions[0].isKid;
      isOPICMode=!!questions[0].isOPIc;
      if(isKidTheme) document.body.classList.add('roblox-theme');
      renderCard();
    })
    .catch(err=>{
      document.getElementById('main-content').innerHTML=
        `<h3 style="color:red;text-align:center;">Network error: ${err}</h3>`;
    });

  function playClick(){ if(isKidTheme) document.getElementById('snd-click').play().catch(()=>{}); }
  function playOof(){   if(isKidTheme) document.getElementById('snd-oof').play().catch(()=>{}); }

  /* =========================================================
     SVG AVATAR (ÏÉùÎûµ ÏóÜÏù¥ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©)
  ========================================================= */
  function buildSVG(gender, emotion){
    const F=gender==='female';
    const skin=F?'#ffd5ae':'#f0b87a', hair=F?'#1a1a2e':'#2c3e50', suit=F?'#2980b9':'#1a252f';

    const body =`<path d="M 10,100 Q 30,70 50,65 Q 70,70 90,100 Z" fill="${suit}"/>
                 <path d="M 42,65 L 50,77 L 58,65" fill="#ecf0f1" opacity="0.85"/>`;
    const face =`<ellipse cx="50" cy="47" rx="23" ry="27" fill="${skin}"/>`;

    const hairSVG = F
      ? `<path d="M 27,22 Q 25,8 50,6 Q 75,8 73,22 Q 80,12 78,38 Q 82,60 76,82 L 74,48 Q 74,28 50,22 Q 26,28 26,48 L 24,82 Q 18,60 22,38 Q 20,12 27,22 Z" fill="${hair}"/>
         <path d="M 24,52 Q 20,75 22,100" stroke="${hair}" stroke-width="9" fill="none" stroke-linecap="round"/>
         <path d="M 76,52 Q 80,75 78,100" stroke="${hair}" stroke-width="9" fill="none" stroke-linecap="round"/>`
      : `<path d="M 29,46 Q 29,16 50,14 Q 71,16 71,46 Q 71,28 50,23 Q 29,28 29,46 Z" fill="${hair}"/>`;

    const emoMap={
      urgent:    {bY:3, bAL:28, bAR:-28, eO:1.3, mT:'wavy', sweat:true},
      worried:   {bY:2, bAL:-18,bAR:18,  eO:0.85,mT:'sad'},
      resigned:  {bY:-3,bAL:-18,bAR:18,  eO:0.5, mT:'flat', bags:true},
      happy:     {bY:-3,bAL:-6, bAR:6,   eO:1.1, mT:'bigSmile'},
      understand:{bY:-2,bAL:0,  bAR:0,   eO:1.0, mT:'smile'},
      exhausted: {bY:0, bAL:0,  bAR:0,   eO:0.3, mT:'flat', bags:true},
      proud:     {bY:-3,bAL:-6, bAR:6,   eO:1.1, mT:'bigSmile'},
      focused:   {bY:4, bAL:18, bAR:-18, eO:0.85,mT:'firm'},
      curious:   {bY:-5,bAL:0,  bAR:0,   eO:1.3, mT:'o'},
      serious:   {bY:3, bAL:6,  bAR:-6,  eO:0.9, mT:'firm'},
      blank:     {bY:0, bAL:0,  bAR:0,   eO:0.8, mT:'dot'},
    };
    const E=emoMap[emotion]||emoMap.serious;

    const eyeL=`<ellipse cx="40" cy="46" rx="4.5" ry="${4.5*E.eO}" fill="#111"/>
                <ellipse cx="41" cy="44.5" rx="1.5" ry="${Math.max(1,1.5*E.eO)}" fill="white" opacity="0.6"/>`;
    const eyeR=`<ellipse cx="60" cy="46" rx="4.5" ry="${4.5*E.eO}" fill="#111"/>
                <ellipse cx="61" cy="44.5" rx="1.5" ry="${Math.max(1,1.5*E.eO)}" fill="white" opacity="0.6"/>`;
    const nose=`<path d="M 50,50 L 48,58 Q 50,60 52,58 Z" fill="${skin}" stroke="#c8956c" stroke-width="1.2" opacity="0.8"/>`;
    const bY=E.bY;
    const browL=`<path d="M 33,${39+bY} Q 40,${37+bY} 47,${39+bY}" stroke="#333" stroke-width="3" fill="none" stroke-linecap="round" transform="rotate(${E.bAL},40,${38+bY})"/>`;
    const browR=`<path d="M 53,${39+bY} Q 60,${37+bY} 67,${39+bY}" stroke="#333" stroke-width="3" fill="none" stroke-linecap="round" transform="rotate(${E.bAR},60,${38+bY})"/>`;

    const my=64; let mouth='';
    if(E.mT==='flat')     mouth=`<line x1="44" y1="${my}" x2="56" y2="${my}" stroke="#555" stroke-width="2.5" stroke-linecap="round"/>`;
    if(E.mT==='dot')      mouth=`<circle cx="50" cy="${my}" r="2" fill="#555"/>`;
    if(E.mT==='firm')     mouth=`<line x1="42" y1="${my}" x2="58" y2="${my}" stroke="#333" stroke-width="3" stroke-linecap="round"/>`;
    if(E.mT==='sad')      mouth=`<path d="M 44,${my+2} Q 50,${my-5} 56,${my+2}" stroke="#555" stroke-width="2.5" fill="none" stroke-linecap="round"/>`;
    if(E.mT==='smile')    mouth=`<path d="M 44,${my-2} Q 50,${my+6} 56,${my-2}" stroke="#555" stroke-width="2.5" fill="none" stroke-linecap="round"/>`;
    if(E.mT==='bigSmile') mouth=`<path d="M 41,${my-2} Q 50,${my+9} 59,${my-2}" fill="#fff" stroke="#333" stroke-width="2.5"/>`;
    if(E.mT==='o')        mouth=`<ellipse cx="50" cy="${my}" rx="4" ry="5" fill="#333"/>`;
    if(E.mT==='wavy')     mouth=`<path d="M 42,${my} Q 46,${my-4} 50,${my} Q 54,${my+4} 58,${my}" stroke="#555" stroke-width="2.5" fill="none" stroke-linecap="round"/>`;

    const sweat=E.sweat?`<ellipse cx="19" cy="36" rx="3" ry="5" fill="#74b9ff" opacity="0.85"/><ellipse cx="14" cy="48" rx="2.5" ry="4" fill="#74b9ff" opacity="0.7"/>`:'';
    const bags =E.bags ?`<path d="M 34,54 Q 40,58 46,54 M 54,54 Q 60,58 66,54" stroke="#b2bec3" stroke-width="1.5" fill="none"/>`:'';

    return `<svg viewBox="0 0 100 100" width="100%" height="100%">${body}${face}${hairSVG}${eyeL}${eyeR}${nose}${browL}${browR}${mouth}${sweat}${bags}</svg>`;
  }

  /* ‚îÄ‚îÄ Audio ‚îÄ‚îÄ */
  function toggleAudio(autoTimer){
    playClick();
    const synth=window.speechSynthesis;
    const btn=document.getElementById('audio-btn');
    if(!synth){
      alert('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏùåÏÑ± Ìï©ÏÑ±ÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
      return;
    }
    if(isPlayingAudio || synth.speaking){
      synth.cancel();
      isPlayingAudio=false;
      btn.innerHTML=isOPICMode?"‚ñ∂Ô∏è Play Ava's Question":"‚ñ∂Ô∏è Listen Dialogue";
      btn.classList.remove('playing');
      clearInterval(timerInterval);
      return;
    }
    if(!voices || voices.length===0){
      alert('ÏùåÏÑ± Î°úÎî© Ï§ëÏûÖÎãàÎã§. 1~2Ï¥à ÌõÑ Îã§Ïãú ÎàåÎü¨Ï£ºÏÑ∏Ïöî.');
      // Í∞ïÏ†ú Ïû¨ÏãúÎèÑ
      loadVoicesOnce();
      return;
    }

    btn.innerHTML='‚èπÔ∏è Stop';
    btn.classList.add('playing');
    isPlayingAudio=true;

    const q=questions[currentIdx];
    const voiceA=pickVoice(q.coworker_gender==='female') || voices[0];
    const voiceB=pickVoice(q.student_gender==='female')  || voices[0];

    const clean=s=>(s||'')
      .replace(/^[^:]+:\s*/,'')
      .replace(/[*_~\[\]]/g,'')
      .replace(/\[BLANK\]/gi,'blank')
      .trim();

    const spokenA = clean(q.speaker_a);
    // ÌïôÏÉù BÎäî Ìï≠ÏÉÅ ÏôÑÏÑ± Î¨∏Ïû• Í∏∞Î∞òÏúºÎ°ú TTS (Ï†ïÎãµ or gapped_b+answer)
    let spokenB;
    if (finalResults[currentIdx]) {
      spokenB = clean(q.answer);
    } else {
      // [BLANK]Í∞Ä ÏûàÎäî Í≤ΩÏö∞ answerÎ•º Ï±ÑÏõåÎÑ£ÏùÄ Î≤ÑÏ†Ñ
      const base = (q.gapped_b || '').replace(/\[BLANK\]/gi, q.answer || '');
      spokenB = clean(base || q.answer);
    }

    const uA=new SpeechSynthesisUtterance(spokenA);
    uA.voice=voiceA; uA.rate=0.92; uA.pitch=1;

    const uB=new SpeechSynthesisUtterance(spokenB);
    uB.voice=voiceB; uB.rate=0.92; uB.pitch=1;

    const reset=()=>{
      btn.innerHTML=isOPICMode?"‚ñ∂Ô∏è Play Ava's Question":"‚ñ∂Ô∏è Listen Dialogue";
      btn.classList.remove('playing');
      isPlayingAudio=false;
    };

    uB.onend=()=>{
      reset();
      if(autoTimer && isOPICMode && !finalResults[currentIdx]) startOPIcTimer();
    };
    uB.onerror=reset;
    uA.onerror=reset;
    uA.onend=()=>{
      if(isPlayingAudio) setTimeout(()=>synth.speak(uB),400);
    };

    synth.speak(uA);
  }

  function startOPIcTimer(){
    const bar=document.getElementById('timer-bar'),
          fill=document.getElementById('timer-fill'),
          mic=document.getElementById('mic-btn');
    if(!bar) return;
    bar.style.display='block';
    if(mic) mic.style.display='flex';
    let t=40;
    fill.style.width='100%';
    timerInterval=setInterval(()=>{
      t--;
      fill.style.width=(t/40*100)+'%';
      if(t<=0){
        clearInterval(timerInterval);
        submitAnswer();
      }
    },1000);
  }

  function showHint(){
    document.getElementById('hint-btn').style.display='none';
    document.getElementById('hint-text-opic').style.display='block';
  }

  function getHint(chunk,idx,all){
    if(!chunk||questions[currentIdx].stage!==3) return '';
    if(idx===0) return chunk[0]+'‚Ä¶';
    const prev=(all[idx-1]||'').trim().toLowerCase();
    if(prev.endsWith(',')) return chunk[0]+'‚Ä¶';
    const conj=['and','but','because','so','or','if','although','though'];
    if(conj.includes(prev.replace(/[^a-z]/g,'').split(/\s+/).pop())) return chunk[0]+'‚Ä¶';
    return '';
  }

  function norm(t){
    return (t||'').toLowerCase()
      .replace(/[^a-z0-9\s]/g,'')
      .replace(/\s+/g,' ')
      .trim();
  }

  function stripName(text, name){
    if(!text||!name) return text;
    const escName = name.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    return text.replace(new RegExp(`^${escName}[,\\.!\s]+`,'i'),'').trim();
  }

  /* =========================================================
     RENDER CARD
  ========================================================= */
  function renderCard(){
    const q=questions[currentIdx];
    isAnswerSubmitted=false;
    mcqSelectedAnswer=userAnswersState[currentIdx]||'';

    document.getElementById('title').innerText =
      isKidTheme ? `Quest ${currentIdx+1}/${questions.length}` :
      `Mission #${currentIdx+1} (Stage ${q.stage})`;

    const prog='<div class="progress-container">'+
      Array.from({length:questions.length},(_,i)=>`<div class="progress-step ${i<=currentIdx?'active':''}"></div>`).join('')+
      '</div>';

    const svgA=buildSVG(q.coworker_gender, q.emotion_a||'serious');
    const svgB=buildSVG(q.student_gender,  q.emotion_b||'focused');
    const wA=q.coworker_gender==='female'?'female-wrapper':'';
    const wB=q.student_gender==='female'?'female-wrapper':'';

    let rawA=stripName((q.speaker_a||'').replace(/\*\*/g,''), q.student_name||student);

    let bubbleB='', wordBank='', mcqHtml='', micVis='none';

    if(q.type==='MCQ'){
      bubbleB=(q.gapped_b||'')
        .replace(/\*\*/g,'')
        .replace(/(\[BLANK\]\s*)+/g,
          '<span style="letter-spacing:3px;color:#aaa;font-weight:700;">_ _ _ _ _</span>');
      const opts=[q.answer,...(q.distractors||[])].filter(Boolean).sort(()=>Math.random()-.5);
      window._opts=opts;
      mcqHtml='<div class="mcq-area" id="mcq-wrap">'+
        opts.map((o,i)=>`<div class="mcq-btn${mcqSelectedAnswer===o?' selected':''}" data-i="${i}">${o}</div>`).join('')+
        '</div>';
    } else {
      let chunks=[];
      if(Array.isArray(q.chunked_answer)&&q.chunked_answer.length>1) {
        chunks=q.chunked_answer;
      } else {
        const parts=String(q.answer||'')
          .split(/,\s+|(?<=\s)(because|but|and|so|if|although)\s+/i)
          .map(s=>s && s.trim()).filter(Boolean);
        chunks = parts.length>=2 ? parts : [q.answer];
      }
      if(chunks.length>3 && String(q.answer||'').split(' ').length/chunks.length < 1.8){
        const m=[]; for(let j=0;j<chunks.length;j+=2) m.push(chunks.slice(j,j+2).join(' '));
        chunks=m;
      }
      safeWords=[...chunks].sort(()=>Math.random()-.5);

      const slots='<span class="slot-group">'+
        chunks.map((c,i)=>{
          const h=getHint(c,i,chunks);
          return `<span class="slot${h?' hint-slot':''}" id="sl-${i}" data-bi="" onclick="clearSlot(this,${i})">${h||''}</span>`;
        }).join('')+
        '</span>';

      const clean=(q.gapped_b||'')
        .replace(/\*\*/g,'')
        .replace(/(\[BLANK\]\s*)+/g,'[BLANK]');

      bubbleB = clean.includes('[BLANK]') ? clean.replace('[BLANK]',slots) : slots;

      wordBank='<div class="word-bank" id="word-bank">'+
        safeWords.map((w,i)=>`<button class="word-btn" id="wb-${i}" onclick="fill(${i},'wb-${i}')">${w}</button>`).join('')+
        '</div>';

      if(!isOPICMode) micVis='flex';
    }

    let opicX='';
    if(isOPICMode){
      opicX = `
        <button id="hint-btn" class="hint-btn" onclick="showHint()" style="display:block;">üí° Show Korean Hint</button>
        <div id="hint-text-opic" class="hint-text-opic">${q.korean_hint||''}</div>
        <div id="timer-bar" class="timer-bar"><div id="timer-fill" class="timer-fill"></div></div>`;
    }

    const prevBtn=currentIdx>0?`<button class="nav-btn" onclick="goPrev()">‚Üê Prev</button>`:'';

    document.getElementById('main-content').innerHTML=`
      <div class="scenario-box">
        <div class="instruction-text">${q.instruction||''}</div>
        <div class="scenario-text">${q.scenario||''}</div>
      </div>
      ${prog}
      <button id="audio-btn" class="audio-btn" onclick="toggleAudio(${isOPICMode})">
        ${isOPICMode?"‚ñ∂Ô∏è Play Ava's Question":"‚ñ∂Ô∏è Listen Dialogue"}
      </button>
      ${opicX}
      <div class="chat-container">
        <div class="chat-row">
          <div class="chat-avatar-wrapper">
            <div class="chat-avatar-svg ${wA}">${svgA}</div>
            <div class="chat-name">${q.coworker_name||''}</div>
          </div>
          <div class="chat-bubble">${rawA}</div>
        </div>
        <div class="chat-row speaker-b">
          <div class="chat-avatar-wrapper">
            <div class="chat-avatar-svg ${wB}">${svgB}</div>
            <div class="chat-name">${q.student_name||student}</div>
          </div>
          <div class="chat-bubble">${bubbleB}</div>
        </div>
      </div>
      ${mcqHtml}${wordBank}
      <div id="inline-error"></div>
      <button id="mic-btn" class="mic-btn" onclick="startMic()" style="display:${micVis};">üéôÔ∏è Speak Answer</button>
      <div id="tbox" class="transcript-box">üéôÔ∏è <span id="ttext">Îì£Îäî Ï§ë...</span></div>
      <div id="feedback" class="feedback"></div>
      <div class="button-group">
        ${prevBtn}
        <button id="btn" class="submit-btn" onclick="mainBtn()">Submit ‚úì</button>
      </div>`;

    if(q.type==='MCQ'){
      document.getElementById('mcq-wrap').addEventListener('click',e=>{
        const el=e.target.closest('.mcq-btn');
        if(!el || isAnswerSubmitted) return;
        document.querySelectorAll('.mcq-btn').forEach(b=>b.classList.remove('selected'));
        el.classList.add('selected');
        const i=parseInt(el.dataset.i,10);
        mcqSelectedAnswer=window._opts[i];
        userAnswersState[currentIdx]=mcqSelectedAnswer;
      });
    }

    if(finalResults[currentIdx]) restoreState();
    else if(q.type!=='MCQ' && Array.isArray(userAnswersState[currentIdx])) restoreSlots();
  }

  /* ‚îÄ‚îÄ Slot helpers ‚îÄ‚îÄ */
  function fill(wIdx,btnId){
    playClick();
    const slots=document.querySelectorAll('.slot');
    for(let i=0;i<slots.length;i++){
      if(!slots[i].classList.contains('filled')){
        slots[i].innerText=safeWords[wIdx];
        slots[i].dataset.bi=btnId;
        slots[i].classList.add('filled');
        slots[i].classList.remove('hint-slot');
        const wb=document.getElementById(btnId);
        if(wb) wb.classList.add('used');
        userAnswersState[currentIdx]=Array.from(slots).map(
          s=>s.classList.contains('filled')?s.innerText:''
        );
        break;
      }
    }
  }

  function clearSlot(el,idx){
    playClick();
    if(!el.classList.contains('filled')) return;
    if(el.dataset.bi){
      const wb=document.getElementById(el.dataset.bi);
      if(wb) wb.classList.remove('used');
    }
    const q=questions[currentIdx];
    const chunks=Array.isArray(q.chunked_answer)&&q.chunked_answer.length>1?q.chunked_answer:[q.answer];
    const h=getHint(chunks[idx],idx,chunks);
    el.innerText=h||'';
    el.dataset.bi='';
    el.classList.remove('filled');
    if(h) el.classList.add('hint-slot');
    userAnswersState[currentIdx]=Array.from(document.querySelectorAll('.slot')).map(
      s=>s.classList.contains('filled')?s.innerText:''
    );
  }

  function restoreSlots(){
    const saved=userAnswersState[currentIdx];
    if(!Array.isArray(saved)) return;
    saved.forEach((w,i)=>{
      const s=document.getElementById('sl-'+i);
      if(!s||!w) return;
      const wi=safeWords.indexOf(w);
      if(wi>-1){
        const wb=document.getElementById('wb-'+wi);
        if(wb){
          wb.classList.add('used');
          s.dataset.bi='wb-'+wi;
        }
      }
      s.innerText=w;
      s.classList.add('filled');
      s.classList.remove('hint-slot');
    });
  }

  /* ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ */
  function goPrev(){
    playClick();
    if(window.speechSynthesis) window.speechSynthesis.cancel();
    clearInterval(timerInterval);
    if(currentIdx>0){
      currentIdx--;
      renderCard();
    }
  }
  function goNext(){
    playClick();
    currentIdx++;
    if(currentIdx<questions.length) renderCard();
    else finish();
  }

  function mainBtn(){
    const btn=document.getElementById('btn');
    if(btn && btn.dataset.mode==='next') goNext();
    else submitAnswer();
  }

  /* ‚îÄ‚îÄ Submit ‚îÄ‚îÄ */
  function submitAnswer(){
    if(isAnswerSubmitted) return;
    playClick();
    clearInterval(timerInterval);
    stopMic();

    const q=questions[currentIdx];
    let isWin=false, userAnswer='';

    if(q.type==='MCQ'){
      userAnswer=mcqSelectedAnswer;
      if(!userAnswer){
        showErr('Please select an answer!');
        return;
      }
      isWin=norm(userAnswer)===norm(q.answer);
    } else {
      const slots=Array.from(document.querySelectorAll('.slot'));
      if(!slots.every(s=>s.classList.contains('filled'))){
        showErr('Please fill in all the blanks!');
        return;
      }
      userAnswer=slots.map(s=>s.innerText.trim()).join(' ');
      isWin=norm(userAnswer)===norm(q.answer);
    }

    if(!isWin) playOof();

    finalResults[currentIdx]={
      originalIndex:q.originalIndex,
      question:q.speaker_a,
      userAnswer,
      correctAnswer:q.answer,
      isCorrect:isWin
    };
    restoreState();
  }

  function showErr(msg){
    const e=document.getElementById('inline-error');
    if(!e) return;
    e.innerText=msg;
    e.style.display='block';
    setTimeout(()=>{ e.style.display='none'; },2500);
  }

  /* ‚îÄ‚îÄ After answer ‚îÄ‚îÄ */
  function restoreState(){
    isAnswerSubmitted=true;
    const q=questions[currentIdx];
    const res=finalResults[currentIdx];
    if(res.isCorrect){
      try{
        confetti({particleCount:150,spread:80,origin:{y:0.1}});
      }catch(e){}
    }

    const mic=document.getElementById('mic-btn');
    if(mic) mic.style.display='none';
    const tb=document.getElementById('tbox');
    if(tb) tb.classList.remove('show');

    if(q.type!=='MCQ'){
      const chunks=Array.isArray(q.chunked_answer)&&q.chunked_answer.length>1
        ? q.chunked_answer
        : String(q.answer||'').split(' ');
      chunks.forEach((c,i)=>{
        const s=document.getElementById('sl-'+i);
        if(s){
          s.innerText=c;
          s.classList.add('filled');
          s.classList.remove('hint-slot');
        }
      });
      const wb=document.getElementById('word-bank');
      if(wb) wb.style.display='none';
    }

    const why=(q.why_explanation||'').trim()
      || 'This is the most natural native-speaker phrasing for this context.';

    const expHtml=
      `<span style="color:#7f8c8d;font-weight:600;">üìù Original:</span> ${q.original_expr||'(student expression)'}<br>
       <span style="color:#2980b9;font-weight:700;">‚ú® Polished:</span> ${q.answer}
       <span class="why-block">üí° Why: ${why}</span>`;

    const fb=document.getElementById('feedback');
    fb.style.display='block';
    fb.className=res.isCorrect ? 'feedback correct' : 'feedback wrong';
    fb.innerHTML=
      (res.isCorrect?'<strong>‚úÖ Perfect!</strong>':`<strong>üí™ Ï†ïÎãµ:</strong> ${q.answer}`)+
      `<details class="hint-details" open>
         <summary>üí° Review Note (click to toggle)</summary>
         <div class="explanation">${expHtml}</div>
       </details>`;

    const btn=document.getElementById('btn');
    btn.disabled = true;
    btn.innerText = 'Ï±ÑÏ†ê Ï§ë...';

    setTimeout(()=>{
      btn.innerText=currentIdx<questions.length-1?'Next ‚Üí':'Finish üéâ';
      btn.dataset.mode='next';
      btn.disabled = false;
    },800);
  }

  /* =========================================================
     MIC
  ========================================================= */
  function stopMic(){
    if(recog){
      try{recog.abort();}catch(e){}
      recog=null;
    }
  }

  /* ‚îÄ‚îÄ MIC (Î™®Î∞îÏùº/ÏÇ¨ÌååÎ¶¨ ÌäïÍπÄ Î∞©ÏßÄ ÏµúÏ†ÅÌôî Î∞è ÏóêÎü¨ Ï∂îÏ†Å ÌåùÏóÖ Ï†ÅÏö©) ‚îÄ‚îÄ */
function startMic(){
  playClick();
  if(isAnswerSubmitted) return;

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ 
    alert('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÎßàÏù¥ÌÅ¨Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§. \n‚òÖÏïÑÏù¥Ìè∞ÏùÄ Î∞òÎìúÏãú "Safari", Í∞§Îü≠ÏãúÎäî "Chrome" Ïï±ÏùÑ Ïó¥Ïñ¥ÏÑú Ï†ëÏÜçÌï¥Ï£ºÏÑ∏Ïöî. (Ïπ¥Ïπ¥Ïò§ÌÜ° ÎÇ¥Ïû• Î∏åÎùºÏö∞Ï†Ä Î∂àÍ∞Ä)‚òÖ'); 
    return; 
  }

  // Í∏∞Ï°¥ ÏºúÏ†∏ÏûàÎçò ÎßàÏù¥ÌÅ¨ Í∞ïÏ†ú Ï¥àÍ∏∞Ìôî (Ï∂©Îèå ÏóêÎü¨ Î∞©ÏßÄ)
  if(window.recog) {
    try { window.recog.abort(); } catch(e){}
  }

  window.recog = new SR();
  window.recog.lang = 'en-US';
  window.recog.continuous = false;
  window.recog.interimResults = false; // ‚òÖ ÌïµÏã¨: Î™®Î∞îÏùº ÌäïÍπÄ Ï£ºÏõêÏù∏Ïù¥ÏóàÎçò Ïã§ÏãúÍ∞Ñ Ïù∏Ïãù Í∞ïÏ†ú Ï¢ÖÎ£å

  const micBtn = document.getElementById('mic-btn');
  const tbox = document.getElementById('tbox');
  const ttext = document.getElementById('ttext');

  // ÎßàÏù¥ÌÅ¨Í∞Ä ÏºúÏßà Îïå ÌôîÎ©¥ Î≥ÄÌôî
  window.recog.onstart = () => {
    micBtn.classList.add('listening'); 
    micBtn.innerHTML = 'üéôÔ∏è Listening... (ÎßêÏîÄÌïòÏÑ∏Ïöî)';
    tbox.classList.add('show'); 
    ttext.innerText = 'Îì£Í≥† ÏûàÏäµÎãàÎã§...';
  };

  // ÎßêÏù¥ ÏôÑÏ†ÑÌûà ÎÅùÎÇòÎ©¥ Îî± Ìïú Î≤àÎßå ÌÖçÏä§Ìä∏Î°ú Î≥ÄÌôòÌïòÏó¨ Ï±ÑÏ†ê
  window.recog.onresult = (e) => {
    let spoken = norm(e.results[0][0].transcript);
    ttext.innerText = '"' + spoken + '"';
    
    const q = questions[currentIdx];
    const target = norm(q.answer).split(' ');
    const match = target.filter(w => spoken.split(' ').includes(w)).length;

    // 50% Ïù¥ÏÉÅ Îã®Ïñ¥Í∞Ä ÏùºÏπòÌïòÎ©¥ Ï†ïÎãµ Ï≤òÎ¶¨
    if(match/target.length >= 0.5){
      const chunks = Array.isArray(q.chunked_answer) && q.chunked_answer.length > 1 ? q.chunked_answer : [q.answer];
      chunks.forEach((c,i)=>{ 
        const s = document.getElementById('sl-'+i); 
        if(s){ s.innerText=c; s.classList.add('filled'); s.classList.remove('hint-slot'); } 
      });
      micBtn.classList.remove('listening'); 
      micBtn.innerHTML = 'üéôÔ∏è Speak Answer';
      submitAnswer();
    } else {
      playOof();
      showErr(`Ïù∏Ïãù Ïã§Ìå®: "${spoken}" ‚Äî Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.`);
    }
  };

  // ÏóêÎü¨ Î∞úÏÉù Ïãú ÏõêÏù∏ÏùÑ Ï†ïÌôïÌïòÍ≤å ÌåùÏóÖÏúºÎ°ú ÏïàÎÇ¥
  window.recog.onerror = (e) => {
    micBtn.classList.remove('listening'); 
    micBtn.innerHTML = 'üéôÔ∏è Speak Answer';
    
    if (e.error === 'not-allowed') {
      alert('ÎßàÏù¥ÌÅ¨ Í∂åÌïúÏù¥ Ï∞®Îã®ÎêòÏóàÏäµÎãàÎã§.\nÏ£ºÏÜåÏ∞Ω ÏòÜ(aA Í∏∞Ìò∏ÎÇò ÏûêÎ¨ºÏá†)ÏùÑ ÎàåÎü¨ ÎßàÏù¥ÌÅ¨ Í∂åÌïúÏùÑ "ÌóàÏö©"ÏúºÎ°ú Î∞îÍøîÏ£ºÏÑ∏Ïöî.');
    } else if (e.error !== 'no-speech') {
      alert('ÎßàÏù¥ÌÅ¨ ÏóêÎü¨ Î∞úÏÉù: ' + e.error);
    }
  };

  window.recog.onend = () => {
    if(!isAnswerSubmitted) { 
      micBtn.classList.remove('listening'); 
      micBtn.innerHTML = 'üéôÔ∏è Speak Answer'; 
    }
  };

  try { 
    window.recog.start(); 
  } catch(e) { 
    alert('ÎßàÏù¥ÌÅ¨Î•º Ïº§ Ïàò ÏóÜÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ® Ìï¥Ï£ºÏÑ∏Ïöî.'); 
  }
}

  /* ‚îÄ‚îÄ Finish ‚îÄ‚îÄ */
  function finish(){
    const valid=finalResults.filter(Boolean);
    const correct=valid.filter(r=>r.isCorrect).length;
    document.getElementById('title').innerText='üéâ Mission Clear!';
    document.getElementById('main-content').innerHTML=`
      <h2 style="text-align:center;">Great job, ${student}! üéä</h2>
      <h3 style="text-align:center;">Score: ${correct} / ${questions.length}</h3>
      <p style="text-align:center;color:#7f8c8d;font-size:13px;">Saving & analyzing... ‚è≥</p>
      <button id="complete-btn" class="submit-btn" style="margin-top:25px;width:100%;opacity:0.5;" disabled>
        Please wait...
      </button>`;

    fetch(API_URL+'?action=saveResult&name='+encodeURIComponent(student),{
      method:'POST',
      body:JSON.stringify(valid)
    })
      .then(()=>{
        const b=document.getElementById('complete-btn');
        b.innerText='‚úÖ Session Saved ‚Äì Close this tab';
        b.style.opacity='1';
        b.disabled=false;
        b.onclick=()=>{
          try{
            window.close();
          } catch(e){
            // ÏùºÎ∂Ä Î∏åÎùºÏö∞Ï†ÄÎäî Ïä§ÌÅ¨Î¶ΩÌä∏Í∞Ä Ïó∞ÏßÄ ÏïäÏùÄ ÌÉ≠ÏùÑ Îã´ÏßÄ Î™ªÌï®[web:11][web:13][web:16]
          }
        };
      })
      .catch(()=>{
        const b=document.getElementById('complete-btn');
        b.innerText='‚ö†Ô∏è Save failed ‚Äì Tap to close';
        b.style.opacity='1';
        b.disabled=false;
        b.onclick=()=>{
          try{
            window.close();
          } catch(e){}
        };
      });
  }
</script>
</body>
</html>
