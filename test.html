<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>English Mission</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: #eef2f5; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 20px 0; }
    .card { background: white; border-radius: 28px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 92%; max-width: 500px; overflow: hidden; }
    .banner { background: #2c3e50; padding: 0 20px; height: 58px; display: flex; align-items: center; }
    .banner-text { color: white; font-size: 16px; font-weight: 700; margin: 0; }
    .content { padding: 22px; }
    .loading-wrap { text-align: center; padding: 40px 20px; }
    .loading-num { font-size: 60px; font-weight: 900; color: #3498db; }
    .loading-msg { color: #7f8c8d; font-size: 14px; margin-top: 10px; }
    .scenario-box { background: #f8f9fa; padding: 14px; border-radius: 12px; border-left: 4px solid #3498db; margin-bottom: 20px; }
    .instruction { font-size: 13px; font-weight: 800; color: #2980b9; margin-bottom: 4px; }
    .scenario { font-size: 12.5px; color: #555; line-height: 1.5; margin: 0; }
    .audio-btn { width: 100%; padding: 13px; background: #2ecc71; color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; margin-bottom: 20px; transition: 0.2s; }
    .audio-btn.playing { background: #e74c3c; }
    .chat-wrap { display: flex; flex-direction: column; gap: 18px; margin-bottom: 22px; }
    .chat-row { display: flex; align-items: flex-start; gap: 12px; }
    .chat-row.b { flex-direction: row-reverse; }
    .avatar-wrap { display: flex; flex-direction: column; align-items: center; width: 75px; flex-shrink: 0; }
    .avatar-svg { width: 70px; height: 70px; border-radius: 50%; overflow: hidden; border: 3px solid #bdc3c7; background: #ecf0f1; }
    .avatar-svg.female { border-color: #3498db; background: #e3f2fd; }
    .avatar-name { font-size: 11px; font-weight: 700; color: #888; margin-top: 5px; text-align: center; }
    .bubble { background: #f1f2f6; padding: 14px 16px; border-radius: 18px; font-size: 14.5px; line-height: 1.6; color: #2c3e50; max-width: calc(100% - 95px); }
    .chat-row.b .bubble { background: #eef2f7; border: 2px solid #3498db; font-weight: 600; }
    .slot-group { display: inline-flex; flex-wrap: wrap; gap: 5px; vertical-align: middle; }
    .slot { padding: 4px 10px; border: 2px dashed #bdc3c7; border-radius: 8px; min-width: 36px; min-height: 28px; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; color: #2c3e50; cursor: pointer; background: white; font-size: 14px; position: relative; }
    .slot.filled { border-style: solid; border-color: #3498db; background: #eef2f7; }
    .slot-hint { position: absolute; top: -8px; left: 4px; font-size: 10px; color: #e74c3c; font-weight: 800; background: white; padding: 0 2px; }
    .word-bank { display: flex; flex-wrap: wrap; gap: 8px; margin: 18px 0 15px; justify-content: center; }
    .word-btn { background: white; border: 2px solid #3498db; color: #3498db; padding: 8px 15px; border-radius: 14px; font-weight: 700; cursor: pointer; font-size: 14px; transition: 0.15s; }
    .word-btn:hover { background: #3498db; color: white; }
    .word-btn.used { opacity: 0.3; pointer-events: none; }
    .mcq-btn { width: 100%; text-align: left; padding: 14px 16px; background: white; border: 2px solid #e8ecf0; border-radius: 12px; font-size: 14px; font-weight: 600; color: #34495e; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
    .mcq-btn:hover { border-color: #3498db; }
    .mcq-btn.selected { background: #3498db; color: white; border-color: #3498db; }
    .mic-section { margin-top: 12px; }
    .mic-info { text-align: center; color: #e74c3c; font-size: 13px; font-weight: 700; background: #fdedec; padding: 10px; border-radius: 8px; margin-bottom: 8px; }
    .mic-btn { width: 100%; padding: 15px; background: #e74c3c; color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; transition: 0.2s; }
    .mic-btn.listening { background: #c0392b; animation: pulse 1s infinite; }
    .mic-result { background: #fff3cd; border: 1px solid #ffc107; padding: 10px 14px; border-radius: 8px; font-size: 13px; margin-top: 8px; display: none; }
    .mic-submit-btn { width: 100%; padding: 12px; background: #8e44ad; color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 8px; display: none; }
    @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.02); } }
    .error-box { background: #fdedec; color: #e74c3c; padding: 10px 14px; border-radius: 8px; font-weight: 700; font-size: 13px; margin-top: 12px; display: none; }
    .feedback { margin-top: 18px; padding: 18px; border-radius: 12px; font-size: 14px; line-height: 1.6; display: none; }
    .feedback.correct { background: #e8f8f5; color: #1abc9c; border: 1px solid #1abc9c; }
    .feedback.wrong { background: #fdedec; color: #c0392b; border: 1px solid #e74c3c; }
    .feedback-note { margin-top: 10px; font-size: 13px; color: #555; background: white; padding: 10px; border-radius: 8px; }
    .btn-group { display: flex; gap: 10px; margin-top: 16px; }
    .prev-btn { flex: 1; padding: 15px; background: #95a5a6; color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; }
    .next-btn { flex: 2; padding: 15px; background: #3498db; color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; }
    .result-item { background: #f8f9fa; padding: 14px; border-radius: 10px; margin-bottom: 10px; font-size: 13px; border-left: 4px solid #bdc3c7; }
    .result-item.pass { border-left-color: #2ecc71; }
    .result-item.fail { border-left-color: #e74c3c; }
  </style>
</head>
<body>
<div id="app" class="card">
  <div class="banner"><h1 id="title" class="banner-text">Loading...</h1></div>
  <div id="content" class="content">
    <div class="loading-wrap">
      <div class="loading-num" id="pct">0%</div>
      <p class="loading-msg">ğŸš€ AI Coach preparing your mission...</p>
    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxr2-JUh8aQnh7zkygYpZwoquVgwYzoA6CgDxhyrbK8ib0-sh7v_Wk7d2N1VB2mwX2g/exec";
const params = new URLSearchParams(window.location.search);
const student = params.get('name') || 'ì€ì˜';

let questions = [], idx = 0, results = [];
let voices = [], audioPlaying = false;
let chunks = [], mcqSelected = "";

// TTS ìŒì„± ë¡œë“œ
function loadVoices() {
  voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
}
if (window.speechSynthesis) {
  loadVoices();
  speechSynthesis.onvoiceschanged = loadVoices;
}

// ë¡œë”© ë°”
let pct = 0;
const pctTimer = setInterval(() => {
  pct = Math.min(pct + (pct < 80 ? Math.random()*8+2 : 1), 95);
  const el = document.getElementById('pct');
  if (el) el.innerText = Math.round(pct) + "%";
}, 300);

// ë°ì´í„° ë¡œë“œ
fetch(API_URL + "?action=getData&name=" + encodeURIComponent(student))
  .then(r => r.json())
  .then(data => {
    clearInterval(pctTimer);
    const el = document.getElementById('pct');
    if (el) el.innerText = "100%";
    if (!Array.isArray(data) || data.error) {
      document.getElementById('content').innerHTML = '<div style="color:red;padding:20px;text-align:center;font-weight:700;">âŒ ' + (data.error || "ë°ì´í„° ì˜¤ë¥˜") + '</div>';
      return;
    }
    questions = data;
    setTimeout(render, 400);
  })
  .catch(err => {
    clearInterval(pctTimer);
    document.getElementById('content').innerHTML = '<div style="color:red;padding:20px;text-align:center;">ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜<br>' + err + '</div>';
  });

// í­ì£½
function confetti() {
  ['ğŸ‰','âœ¨','ğŸ‘','ğŸ’¯','ğŸ”¥','ğŸŒŸ'].forEach((e, i) => {
    for (let j = 0; j < 5; j++) {
      const d = document.createElement('div');
      d.innerText = e;
      d.style.cssText = 'position:fixed;left:'+(Math.random()*100)+'vw;top:-40px;font-size:'+(Math.random()*18+18)+'px;z-index:9999;pointer-events:none;transition:top 1.8s ease-in,opacity 1.8s';
      document.body.appendChild(d);
      setTimeout(() => { d.style.top = '110vh'; d.style.opacity = '0'; }, 50 + i*30);
      setTimeout(() => d.remove(), 2000);
    }
  });
}

// SVG ì•„ë°”íƒ€
const EMOTIONS = {
  curious:   {bY:-2,bAL:0,bAR:-20,eO:1.1,mT:'o'},
  worried:   {bY:1,bAL:-15,bAR:15,eO:0.8,mT:'sad'},
  happy:     {bY:-2,bAL:-5,bAR:5,eO:1.0,mT:'smile',blush:true},
  focused:   {bY:3,bAL:15,bAR:-15,eO:0.85,mT:'firm'},
  serious:   {bY:2,bAL:5,bAR:-5,eO:0.9,mT:'firm'},
  urgent:    {bY:2,bAL:25,bAR:-25,eO:1.2,mT:'wavy',sweat:true},
  exhausted: {bY:0,bAL:0,bAR:0,eO:0.3,mT:'flat',bags:true},
  proud:     {bY:-2,bAL:-5,bAR:5,eO:1.0,mT:'bigSmile'},
  resigned:  {bY:-2,bAL:-15,bAR:15,eO:0.5,mT:'flat',bags:true}
};
const EMO_MAP = {neutral:'serious',relieved:'happy',glad:'happy',angry:'urgent',sad:'resigned',blank:'serious'};
function emo(raw) { const c=(raw||'').toLowerCase().replace(/[^a-z]/g,''); return EMO_MAP[c]||(EMOTIONS[c]?c:'serious'); }

function buildSVG(gender, emotion) {
  const F = gender==='female';
  const E = EMOTIONS[emo(emotion)] || EMOTIONS.serious;
  const skin=F?'#ffe0bd':'#f1c27d', hair='#2c3e50', suit='#1a252f';
  const bY=E.bY||0, bAL=E.bAL||0, bAR=E.bAR||0, eO=E.eO||1;
  let mouth='';
  if(E.mT==='flat') mouth='<line x1="44" y1="70" x2="56" y2="70" stroke="#333" stroke-width="2.5" stroke-linecap="round"/>';
  if(E.mT==='firm') mouth='<line x1="40" y1="70" x2="60" y2="70" stroke="#333" stroke-width="3" stroke-linecap="round"/>';
  if(E.mT==='sad') mouth='<path d="M45,73 Q50,65 55,73" stroke="#333" stroke-width="2.5" fill="none" stroke-linecap="round"/>';
  if(E.mT==='smile') mouth='<path d="M44,68 Q50,76 56,68" stroke="#333" stroke-width="2.5" fill="none" stroke-linecap="round"/>';
  if(E.mT==='bigSmile') mouth='<path d="M42,68 Q50,80 58,68 Z" fill="#fff" stroke="#333" stroke-width="2"/>';
  if(E.mT==='o') mouth='<circle cx="50" cy="72" r="4" fill="#333"/>';
  if(E.mT==='wavy') mouth='<path d="M42,72 Q46,68 50,72 Q54,76 58,72" stroke="#333" stroke-width="2.5" fill="none" stroke-linecap="round"/>';
  const extras =
    (E.blush?'<ellipse cx="35" cy="58" rx="6" ry="3" fill="#e74c3c" opacity="0.25"/><ellipse cx="65" cy="58" rx="6" ry="3" fill="#e74c3c" opacity="0.25"/>':'') +
    (E.sweat?'<ellipse cx="15" cy="42" rx="3" ry="5" fill="#3498db" opacity="0.7"/><ellipse cx="85" cy="42" rx="3" ry="5" fill="#3498db" opacity="0.7"/>':'') +
    (E.bags?'<path d="M32,58 Q38,62 44,58 M56,58 Q62,62 68,58" stroke="#333" stroke-width="1.5" fill="none" opacity="0.35"/>':'');
  const hairSVG = F
    ? '<path d="M20,80 Q20,10 50,10 Q80,10 80,80 Q85,90 75,90 L75,50 Q50,20 25,50 L25,90 Q15,90 20,80 Z" fill="'+hair+'"/>'
    : '<path d="M23,50 Q23,10 50,10 Q77,10 77,50 Q77,30 50,25 Q23,30 23,50 Z" fill="'+hair+'"/><rect x="23" y="45" width="6" height="15" rx="3" fill="'+hair+'"/><rect x="71" y="45" width="6" height="15" rx="3" fill="'+hair+'"/>';
  return '<svg viewBox="0 0 100 100" width="100%" height="100%">' +
    '<path d="M10,120 Q50,75 90,120 Z" fill="'+suit+'"/><path d="M35,120 L50,85 L65,120 Z" fill="white"/>' +
    (F?'':'<polygon points="46,105 42,120 58,120 54,105" fill="#c0392b"/>') +
    '<rect x="42" y="75" width="16" height="20" fill="'+skin+'"/>' +
    '<rect x="25" y="25" width="50" height="60" rx="25" fill="'+skin+'"/>' +
    hairSVG +
    '<ellipse cx="38" cy="50" rx="4" ry="'+(4*eO)+'" fill="#111"/>' +
    '<ellipse cx="62" cy="50" rx="4" ry="'+(4*eO)+'" fill="#111"/>' +
    '<line x1="30" y1="'+(42+bY)+'" x2="45" y2="'+(42+bY)+'" stroke="#333" stroke-width="3" stroke-linecap="round" transform="rotate('+bAL+',37.5,42)"/>' +
    '<line x1="55" y1="'+(42+bY)+'" x2="70" y2="'+(42+bY)+'" stroke="#333" stroke-width="3" stroke-linecap="round" transform="rotate('+bAR+',62.5,42)"/>' +
    mouth + extras + '</svg>';
}

// TTS ì¬ìƒ
function playAudio(answered) {
  const btn = document.getElementById('audio-btn');
  if (!btn) return;
  if (audioPlaying || speechSynthesis.speaking) {
    speechSynthesis.cancel();
    btn.className='audio-btn'; btn.innerText='â–¶ï¸ ëŒ€í™” ë“£ê¸°'; audioPlaying=false;
    return;
  }
  if (!voices.length) { loadVoices(); if(!voices.length) return; }
  const q = questions[idx];
  const tA = (q.speaker_a||'').replace(/\*\*/g,'').replace(/\[BLANK\]/g,'blank').replace(/^[^:]+:/,'').trim();
  const tB = (answered ? q.full_b : q.gapped_b.replace(/\[BLANK\]/g,'blank')).replace(/\*\*/g,'').replace(/^[^:]+:/,'').trim();

  // â˜… ìì—°ìŠ¤ëŸ¬ìš´ ëª©ì†Œë¦¬ ì„ íƒ
  const allVoices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
  const femaleVoices = allVoices.filter(v => /female|woman|girl|samantha|victoria|karen|susan|moira/i.test(v.name));
  const maleVoices = allVoices.filter(v => /male|man|daniel|alex|fred|thomas|oliver/i.test(v.name));
  const vFemale = femaleVoices[0] || allVoices.find(v => v.name.includes('Samantha')) || allVoices[0];
  const vMale = maleVoices[0] || allVoices.find(v => v.name.includes('Daniel')) || allVoices[allVoices.length-1];

  const uA = new SpeechSynthesisUtterance(tA);
  const uB = new SpeechSynthesisUtterance(tB);
  uA.voice = q.student_gender==='female' ? vMale : vFemale;
  uB.voice = q.student_gender==='female' ? vFemale : vMale;
  uA.rate = 0.9; uB.rate = 0.9;
  uA.pitch = q.student_gender==='female' ? 0.9 : 1.1;
  uB.pitch = q.student_gender==='female' ? 1.1 : 0.9;

  btn.className='audio-btn playing'; btn.innerText='â¹ï¸ ë©ˆì¶¤'; audioPlaying=true;
  uB.onend = () => { btn.className='audio-btn'; btn.innerText='â–¶ï¸ ëŒ€í™” ë“£ê¸°'; audioPlaying=false; };
  uA.onend = () => { if(audioPlaying) setTimeout(()=>speechSynthesis.speak(uB),400); };
  speechSynthesis.speak(uA);
}

// ë©”ì¸ ë Œë”
function render() {
  if (!questions.length) return;
  const q = questions[idx];
  const stage = q.stage || 1;
  const isMCQ = q.type === "MCQ";
  const stageColors = ['','#2ecc71','#f39c12','#e74c3c'];
  const stageLabels = ['','Stage 1','Stage 2','Stage 3'];

  document.getElementById('title').innerHTML = 'Mission #'+(idx+1)+
    ' <span style="background:'+stageColors[stage]+';color:white;padding:2px 10px;border-radius:20px;font-size:11px;font-weight:800;margin-left:6px;vertical-align:middle;">'+stageLabels[stage]+'</span>';

  const gB = q.student_gender==='female' ? 'female' : 'male';
  const gA = gB==='female' ? 'male' : 'female';
  const svgA = buildSVG(gA, q.emotion_a||'curious');
  const svgB = buildSVG(gB, q.emotion_b||'focused');
  const fcA = gA==='female' ? 'female' : '';
  const fcB = gB==='female' ? 'female' : '';

  let cleanGapped = (q.gapped_b||'').replace(/\*\*/g,'').replace(/(\[BLANK\]\s*)+/g,'[BLANK]');
  let interactiveHTML = '';

  if (!isMCQ) {
    chunks = Array.isArray(q.chunks) && q.chunks.length > 0 ? q.chunks :
      (q.answer||'').split(' ').map((w,i) => ({text:w, hint_letter: i===0 ? w[0] : null}));
    const slotsHTML = '<div class="slot-group">' +
      chunks.map((ch, i) => {
        const hint = ch.hint_letter ? '<span class="slot-hint">'+ch.hint_letter+'</span>' : '';
        return '<div class="slot" id="slot-'+i+'" data-idx="'+i+'" onclick="clearSlot(this)">'+hint+'</div>';
      }).join('') + '</div>';
    const shuffled = [...chunks].map((c,i) => ({...c, origIdx:i})).sort(() => Math.random()-0.5);
    interactiveHTML = '<div class="word-bank">' +
      shuffled.map(ch => '<button class="word-btn" id="wb-'+ch.origIdx+'" onclick="fillSlot(this,'+ch.origIdx+')">'+ch.text+'</button>').join('') +
      '</div>';
    cleanGapped = cleanGapped.replace(/\[BLANK\]/g, slotsHTML);
  } else {
    cleanGapped = cleanGapped.replace(/\[BLANK\]/g, '<span style="border-bottom:2px solid #3498db;padding:0 20px;">___</span>');
  }

  const prevBtn = idx > 0 ? '<button class="prev-btn" onclick="goPrev()">â† ì´ì „</button>' : '';

  let html = '<div class="scenario-box"><div class="instruction">'+q.instruction+'</div><div class="scenario">ğŸ’¡ '+(q.scenario||'')+'</div></div>';
  html += '<button id="audio-btn" class="audio-btn" onclick="playAudio(false)">â–¶ï¸ ëŒ€í™” ë“£ê¸°</button>';
  html += '<div class="chat-wrap">';
  html += '<div class="chat-row"><div class="avatar-wrap"><div class="avatar-svg '+fcA+'">'+svgA+'</div><div class="avatar-name">'+q.coworker_name+'</div></div><div class="bubble">'+(q.speaker_a||'').replace(/\*\*/g,'')+'</div></div>';
  html += '<div class="chat-row b"><div class="avatar-wrap"><div class="avatar-svg '+fcB+'">'+svgB+'</div><div class="avatar-name">'+q.student_name+'</div></div><div class="bubble">'+cleanGapped+'</div></div>';
  html += '</div>';

  if (isMCQ) {
    const opts = [q.answer,...(q.distractors||[])].filter(Boolean).sort(() => Math.random()-0.5);
    html += '<div id="mcq-area">'+opts.map((o,i) => '<button class="mcq-btn" id="mcq-'+i+'" onclick="selectMCQ(this,\''+o.replace(/'/g,"\\'")+'\')">'+o+'</button>').join('')+'</div>';
  } else {
    html += interactiveHTML;
    html += '<div class="mic-section">';
    html += '<div class="mic-info">ğŸ™ï¸ '+(q.isLow ? 'ë¹ˆì¹¸ ë‹¨ì–´ë§Œ ë§í•´ì£¼ì„¸ìš”!' : 'Speak ONLY the target words.')+'</div>';
    html += '<button class="mic-btn" id="mic-btn" onclick="startMic()">ğŸ™ï¸ '+(q.isLow ? 'ë§ˆì´í¬ ì¼œê¸°' : 'Speak Answer')+'</button>';
    html += '<div class="mic-result" id="mic-result"></div>';
    html += '<button class="mic-submit-btn" id="mic-submit" onclick="submitMicAnswer()">âœ… ì´ ë°œìŒìœ¼ë¡œ ì •ë‹µ í™•ì¸</button>';
    html += '</div>';
  }

  html += '<div class="error-box" id="err-box"></div>';
  html += '<div class="feedback" id="feedback"></div>';
  html += '<div class="btn-group">'+prevBtn+'<button class="next-btn" id="main-btn" onclick="checkAnswer('+(isMCQ)+')">ì •ë‹µ í™•ì¸</button></div>';

  document.getElementById('content').innerHTML = html;
  mcqSelected = '';
  audioPlaying = false;

  if (results[idx]) restoreResult();
}

function restoreResult() {
  const saved = results[idx];
  if (!saved) return;
  const q = questions[idx];
  const fb = document.getElementById('feedback');
  fb.className = 'feedback ' + (saved.isCorrect ? 'correct' : 'wrong');
  fb.style.display = 'block';
  fb.innerHTML = saved.isCorrect
    ? '<strong>âœ… Perfect!</strong><br><br>'+(q.full_b||'').replace(/\*\*/g,'')
    : '<strong>ğŸ’ª ì •ë‹µ: </strong>'+q.answer+'<div class="feedback-note">'+(q.explanation||'')+'</div>';
  ['mic-btn','mic-result','mic-submit'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  const btn = document.getElementById('main-btn');
  btn.innerText = idx < questions.length-1 ? 'ë‹¤ìŒ ë¯¸ì…˜ >' : 'ê²°ê³¼ ë³´ê¸° ğŸ¯';
  btn.onclick = () => { speechSynthesis.cancel(); idx < questions.length-1 ? (idx++, render()) : finish(); };
}

function goPrev() {
  speechSynthesis.cancel();
  if (idx > 0) { idx--; render(); }
}

function selectMCQ(btn, opt) {
  document.querySelectorAll('.mcq-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  mcqSelected = opt;
  document.getElementById('err-box').style.display = 'none';
}

function fillSlot(btn, origIdx) {
  const slots = document.querySelectorAll('.slot');
  for (let s of slots) {
    if (s.dataset.filled === '' || s.dataset.filled === undefined) {
      const hintEl = s.querySelector('.slot-hint');
      const hintHTML = hintEl ? hintEl.outerHTML : '';
      s.innerHTML = hintHTML + chunks[origIdx].text;
      s.dataset.filled = String(origIdx);
      s.classList.add('filled');
      btn.classList.add('used');
      document.getElementById('err-box').style.display = 'none';
      break;
    }
  }
}

function clearSlot(s) {
  if (s.dataset.filled !== undefined && s.dataset.filled !== '') {
    const origIdx = parseInt(s.dataset.filled);
    const wb = document.getElementById('wb-'+origIdx);
    if (wb) wb.classList.remove('used');
    const hintEl = s.querySelector('.slot-hint');
    const hintHTML = hintEl ? hintEl.outerHTML : '';
    s.innerHTML = hintHTML;
    s.dataset.filled = '';
    s.classList.remove('filled');
  }
}

function showErr(msg) {
  const e = document.getElementById('err-box');
  e.innerText = 'ğŸš¨ ' + msg;
  e.style.display = 'block';
}

// â˜…â˜…â˜… ë§ˆì´í¬ - ë§¤ë²ˆ ìƒˆë¡œ ìƒì„±í•˜ëŠ” ë°©ì‹ (ê°€ì¥ ì•ˆì •ì )
function startMic() {
  const micBtn = document.getElementById('mic-btn');
  const micResult = document.getElementById('mic-result');
  const micSubmit = document.getElementById('mic-submit');

  // ì§€ì› ì—¬ë¶€ í™•ì¸
  const SRClass = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SRClass) {
    showErr("ì´ ë¸Œë¼ìš°ì €ëŠ” ë§ˆì´í¬ë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ìš”. Chromeì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
    return;
  }

  // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
  micBtn.className = 'mic-btn listening';
  micBtn.innerText = 'ğŸ™ï¸ ë“£ê³  ìˆìŠµë‹ˆë‹¤...';
  micResult.style.display = 'none';
  micSubmit.style.display = 'none';

  // â˜… ë§¤ë²ˆ ìƒˆ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (abort/ì¬ì‚¬ìš© ë¬¸ì œ ì™„ì „ í•´ê²°)
  const rec = new SRClass();
  rec.lang = 'en-US';
  rec.continuous = false;
  rec.interimResults = false;
  rec.maxAlternatives = 1;

  rec.onstart = function() {
    micBtn.className = 'mic-btn listening';
    micBtn.innerText = 'ğŸ™ï¸ ë“£ê³  ìˆìŠµë‹ˆë‹¤...';
  };

  rec.onresult = function(event) {
    const spoken = event.results[0][0].transcript;
    const spokenClean = spoken.toLowerCase().replace(/[.,!?']/g,'').trim();

    micBtn.className = 'mic-btn';
    micBtn.innerText = 'ğŸ™ï¸ ë‹¤ì‹œ ë§í•˜ê¸°';
    micResult.style.display = 'block';
    micResult.innerHTML = 'ğŸ—£ï¸ ì¸ì‹ë¨: <strong>"' + spoken + '"</strong>';

    const q = questions[idx];
    const targetWords = (q.answer||'').toLowerCase().replace(/[.,!?']/g,'').trim().split(' ').filter(w=>w);
    let matchCount = 0;
    targetWords.forEach(w => { if (spokenClean.includes(w)) matchCount++; });
    const matchRate = targetWords.length > 0 ? matchCount / targetWords.length : 0;

    if (matchRate >= 0.85) {
      confetti();
      fillSlotsWithAnswer();
      setTimeout(() => checkAnswer(false), 600);
    } else {
      micResult.innerHTML += '<br><span style="color:#e74c3c;font-size:12px;">ë‹¤ì‹œ ë§í•˜ê±°ë‚˜ ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</span>';
      micSubmit.style.display = 'block';
    }
  };

  rec.onerror = function(event) {
    micBtn.className = 'mic-btn';
    micBtn.innerText = 'ğŸ™ï¸ ë‹¤ì‹œ ë§í•˜ê¸°';
    micResult.style.display = 'block';
    if (event.error === 'no-speech') {
      micResult.innerHTML = 'âš ï¸ ì†Œë¦¬ê°€ ì¸ì‹ë˜ì§€ ì•Šì•˜ì–´ìš”. ë‹¤ì‹œ íƒ­í•˜ì„¸ìš”.';
    } else if (event.error === 'not-allowed') {
      micResult.innerHTML = 'âš ï¸ ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•´ìš”. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”.';
    } else {
      micResult.innerHTML = 'âš ï¸ ì˜¤ë¥˜: ' + event.error + ' - ë‹¤ì‹œ íƒ­í•˜ì„¸ìš”';
    }
  };

  rec.onend = function() {
    if (micBtn.classList.contains('listening')) {
      micBtn.className = 'mic-btn';
      micBtn.innerText = 'ğŸ™ï¸ ë‹¤ì‹œ ë§í•˜ê¸°';
    }
  };

  rec.start();
}

function fillSlotsWithAnswer() {
  const slots = document.querySelectorAll('.slot');
  chunks.forEach((ch, i) => {
    if (slots[i]) {
      const hintEl = slots[i].querySelector('.slot-hint');
      const hintHTML = hintEl ? hintEl.outerHTML : '';
      slots[i].innerHTML = hintHTML + ch.text;
      slots[i].dataset.filled = String(i);
      slots[i].classList.add('filled');
      const wb = document.getElementById('wb-'+i);
      if (wb) wb.classList.add('used');
    }
  });
}

function submitMicAnswer() {
  fillSlotsWithAnswer();
  document.getElementById('mic-submit').style.display = 'none';
  checkAnswer(false);
}

function checkAnswer(isMCQ) {
  const q = questions[idx];
  let isWin = false, userAnswer = "";

  if (isMCQ) {
    if (!mcqSelected) return showErr(q.isLow ? "ë³´ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!" : "Please select an answer!");
    userAnswer = mcqSelected;
    isWin = userAnswer.toLowerCase().trim() === (q.answer||'').toLowerCase().trim();
  } else {
    const slots = document.querySelectorAll('.slot');
    const userParts = [];
    for (let s of slots) {
      if (!s.dataset.filled || s.dataset.filled === '') {
        return showErr(q.isLow ? "ë¹ˆì¹¸ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”!" : "Please fill all blanks!");
      }
      userParts.push(chunks[parseInt(s.dataset.filled)].text);
    }
    userAnswer = userParts.join(' ');
    isWin = userAnswer.toLowerCase().trim() === (q.answer||'').toLowerCase().trim();
  }

  document.getElementById('err-box').style.display = 'none';
  if (isWin) confetti();

  const fb = document.getElementById('feedback');
  fb.className = 'feedback ' + (isWin ? 'correct' : 'wrong');
  fb.style.display = 'block';
  let fbHTML = isWin
    ? '<strong>âœ… Perfect!</strong><br><br>' + (q.full_b||'').replace(/\*\*/g,'')
    : '<strong>ğŸ’ª ì •ë‹µ: </strong>' + q.answer;
  if (q.explanation) fbHTML += '<div class="feedback-note">ğŸ’¡ ' + q.explanation + '</div>';
  if (isMCQ && q.distractor_exp) fbHTML += '<div class="feedback-note" style="color:#e67e22;">ğŸš¨ ' + q.distractor_exp + '</div>';
  fb.innerHTML = fbHTML;

  speechSynthesis.cancel();
  audioPlaying = false;
  ['mic-btn','mic-result','mic-submit'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });

  results[idx] = {
    originalIndex: q.originalIndex,
    question: (q.speaker_a||'').replace(/\*\*/g,'') + ' / ' + (q.full_b||'').replace(/\*\*/g,''),
    userAnswer,
    correctAnswer: q.answer,
    isCorrect: isWin
  };

  const btn = document.getElementById('main-btn');
  btn.innerText = idx < questions.length-1 ? 'ë‹¤ìŒ ë¯¸ì…˜ >' : 'ê²°ê³¼ ë³´ê¸° ğŸ¯';
  btn.onclick = () => { speechSynthesis.cancel(); idx < questions.length-1 ? (idx++, render()) : finish(); };
}

function finish() {
  const valid = results.filter(r => r);
  const correct = valid.filter(r => r.isCorrect).length;
  let html = '<h2 style="text-align:center;margin-top:0">Great job, '+student+'! ğŸ‰</h2>';
  html += '<div style="text-align:center;font-size:52px;margin:10px 0">ğŸ†</div>';
  html += '<h3 style="text-align:center;color:#555">Score: '+correct+' / '+questions.length+'</h3>';
  html += '<div style="margin-top:20px">';
  valid.forEach((r, i) => {
    const col = r.isCorrect ? '#2ecc71' : '#e74c3c';
    const ans = !r.isCorrect ? '<div style="color:#3498db;font-size:12px;margin-top:4px;font-weight:700">ì •ë‹µ: '+r.correctAnswer+'</div>' : '';
    html += '<div class="result-item '+(r.isCorrect?'pass':'fail')+'"><strong>Q'+(i+1)+'.</strong> '+r.question+'<div style="margin-top:4px;color:'+col+';font-size:12px">ë‚´ ë‹µ: '+r.userAnswer+'</div>'+ans+'</div>';
  });
  html += '</div>';
  html += '<button class="next-btn" onclick="location.reload()" style="width:100%;margin-top:15px">ğŸ”„ ë‹¤ì‹œ ì‹œì‘</button>';
  document.getElementById('title').innerText = 'Mission Clear!';
  document.getElementById('content').innerHTML = html;

  fetch(API_URL + "?action=saveResult&name=" + encodeURIComponent(student), {
    method: 'POST',
    body: JSON.stringify(valid),
    headers: { 'Content-Type': 'application/json' }
  }).then(() => console.log("ì €ì¥ ì™„ë£Œ")).catch(e => console.log("ì €ì¥ ì‹¤íŒ¨:", e));
}
</script>
</body>
</html>
